!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("spritejs")):"function"==typeof define&&define.amd?define(["spritejs"],e):"object"==typeof exports?exports.ext3d=e(require("spritejs")):(t.spritejs=t.spritejs||{},t.spritejs.ext3d=e(t.spritejs))}(this,(function(t){return function(t){var e=this.webpackHotUpdate;this.webpackHotUpdate=function(t,r){!function(t,e){if(!x[t]||!w[t])return;for(var r in w[t]=!1,e)Object.prototype.hasOwnProperty.call(e,r)&&(m[r]=e[r]);0==--v&&0===b&&S()}(t,r),e&&e(t,r)};var r,i=!0,n="87bc4a0ca92ee9300d28",s=1e4,o={},a=[],h=[];function l(t){var e=_[t];if(!e)return C;var i=function(i){return e.hot.active?(_[i]?-1===_[i].parents.indexOf(t)&&_[i].parents.push(t):(a=[t],r=i),-1===e.children.indexOf(i)&&e.children.push(i)):(console.warn("[HMR] unexpected require("+i+") from disposed module "+t),a=[]),C(i)},n=function(t){return{configurable:!0,enumerable:!0,get:function(){return C[t]},set:function(e){C[t]=e}}};for(var s in C)Object.prototype.hasOwnProperty.call(C,s)&&"e"!==s&&"t"!==s&&Object.defineProperty(i,s,n(s));return i.e=function(t){return"ready"===d&&p("prepare"),b++,C.e(t).then(e,(function(t){throw e(),t}));function e(){b--,"prepare"===d&&(y[t]||A(t),0===b&&0===v&&S())}},i.t=function(t,e){return 1&e&&(t=i(t)),C.t(t,-2&e)},i}function c(t){var e={_acceptedDependencies:{},_declinedDependencies:{},_selfAccepted:!1,_selfDeclined:!1,_disposeHandlers:[],_main:r!==t,active:!0,accept:function(t,r){if(void 0===t)e._selfAccepted=!0;else if("function"==typeof t)e._selfAccepted=t;else if("object"==typeof t)for(var i=0;i<t.length;i++)e._acceptedDependencies[t[i]]=r||function(){};else e._acceptedDependencies[t]=r||function(){}},decline:function(t){if(void 0===t)e._selfDeclined=!0;else if("object"==typeof t)for(var r=0;r<t.length;r++)e._declinedDependencies[t[r]]=!0;else e._declinedDependencies[t]=!0},dispose:function(t){e._disposeHandlers.push(t)},addDisposeHandler:function(t){e._disposeHandlers.push(t)},removeDisposeHandler:function(t){var r=e._disposeHandlers.indexOf(t);r>=0&&e._disposeHandlers.splice(r,1)},check:M,apply:O,status:function(t){if(!t)return d;u.push(t)},addStatusHandler:function(t){u.push(t)},removeStatusHandler:function(t){var e=u.indexOf(t);e>=0&&u.splice(e,1)},data:o[t]};return r=void 0,e}var u=[],d="idle";function p(t){d=t;for(var e=0;e<u.length;e++)u[e].call(null,t)}var g,m,f,v=0,b=0,y={},w={},x={};function E(t){return+t+""===t?+t:t}function M(t){if("idle"!==d)throw new Error("check() is only allowed in idle status");return i=t,p("check"),(e=s,e=e||1e4,new Promise((function(t,r){if("undefined"==typeof XMLHttpRequest)return r(new Error("No browser support"));try{var i=new XMLHttpRequest,s=C.p+""+n+".hot-update.json";i.open("GET",s,!0),i.timeout=e,i.send(null)}catch(t){return r(t)}i.onreadystatechange=function(){if(4===i.readyState)if(0===i.status)r(new Error("Manifest request to "+s+" timed out."));else if(404===i.status)t();else if(200!==i.status&&304!==i.status)r(new Error("Manifest request to "+s+" failed."));else{try{var e=JSON.parse(i.responseText)}catch(t){return void r(t)}t(e)}}}))).then((function(t){if(!t)return p("idle"),null;w={},y={},x=t.c,f=t.h,p("prepare");var e=new Promise((function(t,e){g={resolve:t,reject:e}}));m={};return A(0),"prepare"===d&&0===b&&0===v&&S(),e}));var e}function A(t){x[t]?(w[t]=!0,v++,function(t){var e=document.createElement("script");e.charset="utf-8",e.src=C.p+""+t+"."+n+".hot-update.js",document.head.appendChild(e)}(t)):y[t]=!0}function S(){p("ready");var t=g;if(g=null,t)if(i)Promise.resolve().then((function(){return O(i)})).then((function(e){t.resolve(e)}),(function(e){t.reject(e)}));else{var e=[];for(var r in m)Object.prototype.hasOwnProperty.call(m,r)&&e.push(E(r));t.resolve(e)}}function O(e){if("ready"!==d)throw new Error("apply() is only allowed in ready status");var r,i,s,h,l;function c(t){for(var e=[t],r={},i=e.map((function(t){return{chain:[t],id:t}}));i.length>0;){var n=i.pop(),s=n.id,o=n.chain;if((h=_[s])&&!h.hot._selfAccepted){if(h.hot._selfDeclined)return{type:"self-declined",chain:o,moduleId:s};if(h.hot._main)return{type:"unaccepted",chain:o,moduleId:s};for(var a=0;a<h.parents.length;a++){var l=h.parents[a],c=_[l];if(c){if(c.hot._declinedDependencies[s])return{type:"declined",chain:o.concat([l]),moduleId:s,parentId:l};-1===e.indexOf(l)&&(c.hot._acceptedDependencies[s]?(r[l]||(r[l]=[]),u(r[l],[s])):(delete r[l],e.push(l),i.push({chain:o.concat([l]),id:l})))}}}}return{type:"accepted",moduleId:t,outdatedModules:e,outdatedDependencies:r}}function u(t,e){for(var r=0;r<e.length;r++){var i=e[r];-1===t.indexOf(i)&&t.push(i)}}e=e||{};var g={},v=[],b={},y=function(){console.warn("[HMR] unexpected require("+M.moduleId+") to disposed module")};for(var w in m)if(Object.prototype.hasOwnProperty.call(m,w)){var M;l=E(w);var A=!1,S=!1,O=!1,L="";switch((M=m[w]?c(l):{type:"disposed",moduleId:w}).chain&&(L="\nUpdate propagation: "+M.chain.join(" -> ")),M.type){case"self-declined":e.onDeclined&&e.onDeclined(M),e.ignoreDeclined||(A=new Error("Aborted because of self decline: "+M.moduleId+L));break;case"declined":e.onDeclined&&e.onDeclined(M),e.ignoreDeclined||(A=new Error("Aborted because of declined dependency: "+M.moduleId+" in "+M.parentId+L));break;case"unaccepted":e.onUnaccepted&&e.onUnaccepted(M),e.ignoreUnaccepted||(A=new Error("Aborted because "+l+" is not accepted"+L));break;case"accepted":e.onAccepted&&e.onAccepted(M),S=!0;break;case"disposed":e.onDisposed&&e.onDisposed(M),O=!0;break;default:throw new Error("Unexception type "+M.type)}if(A)return p("abort"),Promise.reject(A);if(S)for(l in b[l]=m[l],u(v,M.outdatedModules),M.outdatedDependencies)Object.prototype.hasOwnProperty.call(M.outdatedDependencies,l)&&(g[l]||(g[l]=[]),u(g[l],M.outdatedDependencies[l]));O&&(u(v,[M.moduleId]),b[l]=y)}var P,T=[];for(i=0;i<v.length;i++)l=v[i],_[l]&&_[l].hot._selfAccepted&&b[l]!==y&&T.push({module:l,errorHandler:_[l].hot._selfAccepted});p("dispose"),Object.keys(x).forEach((function(t){!1===x[t]&&function(t){delete installedChunks[t]}(t)}));for(var R,F,N=v.slice();N.length>0;)if(l=N.pop(),h=_[l]){var D={},j=h.hot._disposeHandlers;for(s=0;s<j.length;s++)(r=j[s])(D);for(o[l]=D,h.hot.active=!1,delete _[l],delete g[l],s=0;s<h.children.length;s++){var I=_[h.children[s]];I&&((P=I.parents.indexOf(l))>=0&&I.parents.splice(P,1))}}for(l in g)if(Object.prototype.hasOwnProperty.call(g,l)&&(h=_[l]))for(F=g[l],s=0;s<F.length;s++)R=F[s],(P=h.children.indexOf(R))>=0&&h.children.splice(P,1);for(l in p("apply"),n=f,b)Object.prototype.hasOwnProperty.call(b,l)&&(t[l]=b[l]);var B=null;for(l in g)if(Object.prototype.hasOwnProperty.call(g,l)&&(h=_[l])){F=g[l];var U=[];for(i=0;i<F.length;i++)if(R=F[i],r=h.hot._acceptedDependencies[R]){if(-1!==U.indexOf(r))continue;U.push(r)}for(i=0;i<U.length;i++){r=U[i];try{r(F)}catch(t){e.onErrored&&e.onErrored({type:"accept-errored",moduleId:l,dependencyId:F[i],error:t}),e.ignoreErrored||B||(B=t)}}}for(i=0;i<T.length;i++){var z=T[i];l=z.module,a=[l];try{C(l)}catch(t){if("function"==typeof z.errorHandler)try{z.errorHandler(t)}catch(r){e.onErrored&&e.onErrored({type:"self-accept-error-handler-errored",moduleId:l,error:r,originalError:t}),e.ignoreErrored||B||(B=r),B||(B=t)}else e.onErrored&&e.onErrored({type:"self-accept-errored",moduleId:l,error:t}),e.ignoreErrored||B||(B=t)}}return B?(p("fail"),Promise.reject(B)):(p("idle"),new Promise((function(t){t(v)})))}var _={};function C(e){if(_[e])return _[e].exports;var r=_[e]={i:e,l:!1,exports:{},hot:c(e),parents:(h=a,a=[],h),children:[]};return t[e].call(r.exports,r,r.exports,l(e)),r.l=!0,r.exports}return C.m=t,C.c=_,C.d=function(t,e,r){C.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},C.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},C.t=function(t,e){if(1&e&&(t=C(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(C.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)C.d(r,i,function(e){return t[e]}.bind(null,i));return r},C.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return C.d(e,"a",e),e},C.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},C.p="/js/",C.h=function(){return n},l(2)(C.s=2)}([function(e,r){e.exports=t},,function(t,e,r){"use strict";r.r(e);var i={};r.r(i),r.d(i,"NORMAL",(function(){return mr})),r.d(i,"NORMAL_GEOMETRY",(function(){return fr})),r.d(i,"NORMAL_TEXTURE",(function(){return vr})),r.d(i,"TEXTURE_CUBE",(function(){return br})),r.d(i,"TEXTURE_WITH_SHADOW",(function(){return yr})),r.d(i,"GEOMETRY_WITH_TEXTURE",(function(){return wr})),r.d(i,"GEOMETRY_WITH_SHADOW",(function(){return xr})),r.d(i,"GEOMETRY_WITH_TEXTURE_AND_SHADOW",(function(){return Er}));function n(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function s(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function o(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t}function a(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}class h extends Array{constructor(t=0,e=t){return super(t,e),this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}set(t,e=t){return t.length?this.copy(t):(function(t,e,r){t[0]=e,t[1]=r}(this,t,e),this)}copy(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],this}add(t,e){return e?n(this,t,e):n(this,this,t),this}sub(t,e){return e?s(this,t,e):s(this,this,t),this}multiply(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]*i[0],e[1]=r[1]*i[1]):o(this,this,t),this}divide(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]/i[0],e[1]=r[1]/i[1]):o(this,this,1/t),this}inverse(t=this){var e,r;return r=t,(e=this)[0]=1/r[0],e[1]=1/r[1],this}len(){return a(this)}distance(t){return t?(e=this,i=(r=t)[0]-e[0],n=r[1]-e[1],Math.sqrt(i*i+n*n)):a(this);var e,r,i,n}squaredLen(){return this.squaredDistance()}squaredDistance(t){return t?(e=this,i=(r=t)[0]-e[0],n=r[1]-e[1],i*i+n*n):function(t){var e=t[0],r=t[1];return e*e+r*r}(this);var e,r,i,n}negate(t=this){var e,r;return r=t,(e=this)[0]=-r[0],e[1]=-r[1],this}cross(t,e){return i=e,(r=t)[0]*i[1]-r[1]*i[0];var r,i}scale(t){return o(this,this,t),this}normalize(){var t,e,r,i,n;return t=this,r=(e=this)[0],i=e[1],(n=r*r+i*i)>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,this}dot(t){return r=t,(e=this)[0]*r[0]+e[1]*r[1];var e,r}equals(t){return r=t,(e=this)[0]===r[0]&&e[1]===r[1];var e,r}applyMatrix3(t){var e,r,i,n,s;return e=this,i=t,n=(r=this)[0],s=r[1],e[0]=i[0]*n+i[3]*s+i[6],e[1]=i[1]*n+i[4]*s+i[7],this}applyMatrix4(t){return function(t,e,r){let i=e[0],n=e[1];t[0]=r[0]*i+r[4]*n+r[12],t[1]=r[1]*i+r[5]*n+r[13]}(this,this,t),this}lerp(t,e){!function(t,e,r,i){var n=e[0],s=e[1];t[0]=n+i*(r[0]-n),t[1]=s+i*(r[1]-s)}(this,this,t,e)}clone(){return new h(this[0],this[1])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t}}function l(t){let e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function c(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function u(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function d(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function p(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function g(t,e){let r=e[0],i=e[1],n=e[2],s=r*r+i*i+n*n;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function m(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function f(t,e,r){let i=e[0],n=e[1],s=e[2],o=r[0],a=r[1],h=r[2];return t[0]=n*h-s*a,t[1]=s*o-i*h,t[2]=i*a-n*o,t}const v=function(){const t=[0,0,0],e=[0,0,0];return function(r,i){c(t,r),c(e,i),g(t,t),g(e,e);let n=m(t,e);return n>1?0:n<-1?Math.PI:Math.acos(n)}}();class b extends Array{constructor(t=0,e=t,r=t){return super(t,e,r),this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}set(t,e=t,r=t){return t.length?this.copy(t):(function(t,e,r,i){t[0]=e,t[1]=r,t[2]=i}(this,t,e,r),this)}copy(t){return c(this,t),this}add(t,e){return e?u(this,t,e):u(this,this,t),this}sub(t,e){return e?d(this,t,e):d(this,this,t),this}multiply(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]*i[0],e[1]=r[1]*i[1],e[2]=r[2]*i[2]):p(this,this,t),this}divide(t){var e,r,i;return t.length?(r=this,i=t,(e=this)[0]=r[0]/i[0],e[1]=r[1]/i[1],e[2]=r[2]/i[2]):p(this,this,1/t),this}inverse(t=this){var e,r;return r=t,(e=this)[0]=1/r[0],e[1]=1/r[1],e[2]=1/r[2],this}len(){return l(this)}distance(t){return t?function(t,e){let r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2];return Math.sqrt(r*r+i*i+n*n)}(this,t):l(this)}squaredLen(){return this.squaredDistance()}squaredDistance(t){return t?function(t,e){let r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2];return r*r+i*i+n*n}(this,t):function(t){let e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}(this)}negate(t=this){var e,r;return r=t,(e=this)[0]=-r[0],e[1]=-r[1],e[2]=-r[2],this}cross(t,e){return f(this,t,e),this}scale(t){return p(this,this,t),this}normalize(){return g(this,this),this}dot(t){return m(this,t)}equals(t){return r=t,(e=this)[0]===r[0]&&e[1]===r[1]&&e[2]===r[2];var e,r}applyMatrix4(t){return function(t,e,r){let i=e[0],n=e[1],s=e[2],o=r[3]*i+r[7]*n+r[11]*s+r[15];o=o||1,t[0]=(r[0]*i+r[4]*n+r[8]*s+r[12])/o,t[1]=(r[1]*i+r[5]*n+r[9]*s+r[13])/o,t[2]=(r[2]*i+r[6]*n+r[10]*s+r[14])/o}(this,this,t),this}applyQuaternion(t){return function(t,e,r){let i=e[0],n=e[1],s=e[2],o=r[0],a=r[1],h=r[2],l=a*s-h*n,c=h*i-o*s,u=o*n-a*i,d=a*u-h*c,p=h*l-o*u,g=o*c-a*l,m=2*r[3];l*=m,c*=m,u*=m,d*=2,p*=2,g*=2,t[0]=i+l+d,t[1]=n+c+p,t[2]=s+u+g}(this,this,t),this}angle(t){return v(this,t)}lerp(t,e){return function(t,e,r,i){let n=e[0],s=e[1],o=e[2];t[0]=n+i*(r[0]-n),t[1]=s+i*(r[1]-s),t[2]=o+i*(r[2]-o)}(this,this,t,e),this}clone(){return new b(this[0],this[1],this[2])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}transformDirection(t){const e=this[0],r=this[1],i=this[2];return this[0]=t[0]*e+t[4]*r+t[8]*i,this[1]=t[1]*e+t[5]*r+t[9]*i,this[2]=t[2]*e+t[6]*r+t[10]*i,this.normalize()}}function y(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function w(t,e,r,i,n){return t[0]=e,t[1]=r,t[2]=i,t[3]=n,t}function x(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=r*r+i*i+n*n+s*s;return o>0&&(o=1/Math.sqrt(o)),t[0]=r*o,t[1]=i*o,t[2]=n*o,t[3]=s*o,t}class E extends Array{constructor(t=0,e=t,r=t,i=t){return super(t,e,r,i),this}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}set(t,e,r,i){return t.length?this.copy(t):(w(this,t,e,r,i),this)}copy(t){return y(this,t),this}normalize(){return x(this,this),this}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}function M(t,e,r){let i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=r[0],p=r[1],g=r[2],m=r[3],f=r[4],v=r[5],b=r[6],y=r[7],w=r[8];return t[0]=d*i+p*o+g*l,t[1]=d*n+p*a+g*c,t[2]=d*s+p*h+g*u,t[3]=m*i+f*o+v*l,t[4]=m*n+f*a+v*c,t[5]=m*s+f*h+v*u,t[6]=b*i+y*o+w*l,t[7]=b*n+y*a+w*c,t[8]=b*s+y*h+w*u,t}class A extends Array{constructor(t=1,e=0,r=0,i=0,n=1,s=0,o=0,a=0,h=1){return super(t,e,r,i,n,s,o,a,h),this}set(t,e,r,i,n,s,o,a,h){return t.length?this.copy(t):(function(t,e,r,i,n,s,o,a,h,l){t[0]=e,t[1]=r,t[2]=i,t[3]=n,t[4]=s,t[5]=o,t[6]=a,t[7]=h,t[8]=l}(this,t,e,r,i,n,s,o,a,h),this)}translate(t,e=this){return function(t,e,r){let i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=r[0],p=r[1];t[0]=i,t[1]=n,t[2]=s,t[3]=o,t[4]=a,t[5]=h,t[6]=d*i+p*o+l,t[7]=d*n+p*a+c,t[8]=d*s+p*h+u}(this,e,t),this}rotate(t,e=this){return function(t,e,r){let i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=Math.sin(r),p=Math.cos(r);t[0]=p*i+d*o,t[1]=p*n+d*a,t[2]=p*s+d*h,t[3]=p*o-d*i,t[4]=p*a-d*n,t[5]=p*h-d*s,t[6]=l,t[7]=c,t[8]=u}(this,e,t),this}scale(t,e=this){return function(t,e,r){let i=r[0],n=r[1];t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=n*e[3],t[4]=n*e[4],t[5]=n*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]}(this,e,t),this}multiply(t,e){return e?M(this,t,e):M(this,this,t),this}identity(){var t;return(t=this)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}copy(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this}fromMatrix4(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],this}fromQuaternion(t){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=r+r,a=i+i,h=n+n,l=r*o,c=i*o,u=i*a,d=n*o,p=n*a,g=n*h,m=s*o,f=s*a,v=s*h;t[0]=1-u-g,t[3]=c-v,t[6]=d+f,t[1]=c+v,t[4]=1-l-g,t[7]=p-m,t[2]=d-f,t[5]=p+m,t[8]=1-l-u}(this,t),this}fromBasis(t,e,r){return this.set(t[0],t[1],t[2],e[0],e[1],e[2],r[0],r[1],r[2]),this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=c*o-a*l,d=-c*s+a*h,p=l*s-o*h,g=r*u+i*d+n*p;g&&(g=1/g,t[0]=u*g,t[1]=(-c*i+n*l)*g,t[2]=(a*i-n*o)*g,t[3]=d*g,t[4]=(c*r-n*h)*g,t[5]=(-a*r+n*s)*g,t[6]=p*g,t[7]=(-l*r+i*h)*g,t[8]=(o*r-i*s)*g)}(this,t),this}getNormalMatrix(t){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],p=e[11],g=e[12],m=e[13],f=e[14],v=e[15],b=r*a-i*o,y=r*h-n*o,w=r*l-s*o,x=i*h-n*a,E=i*l-s*a,M=n*l-s*h,A=c*m-u*g,S=c*f-d*g,O=c*v-p*g,_=u*f-d*m,C=u*v-p*m,L=d*v-p*f,P=b*L-y*C+w*_+x*O-E*S+M*A;P&&(P=1/P,t[0]=(a*L-h*C+l*_)*P,t[1]=(h*O-o*L-l*S)*P,t[2]=(o*C-a*O+l*A)*P,t[3]=(n*C-i*L-s*_)*P,t[4]=(r*L-n*O+s*S)*P,t[5]=(i*O-r*C-s*A)*P,t[6]=(m*M-f*E+v*x)*P,t[7]=(f*w-g*M-v*y)*P,t[8]=(g*E-m*w+v*b)*P)}(this,t),this}}function S(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function O(t,e,r){let i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],p=e[10],g=e[11],m=e[12],f=e[13],v=e[14],b=e[15],y=r[0],w=r[1],x=r[2],E=r[3];return t[0]=y*i+w*a+x*u+E*m,t[1]=y*n+w*h+x*d+E*f,t[2]=y*s+w*l+x*p+E*v,t[3]=y*o+w*c+x*g+E*b,y=r[4],w=r[5],x=r[6],E=r[7],t[4]=y*i+w*a+x*u+E*m,t[5]=y*n+w*h+x*d+E*f,t[6]=y*s+w*l+x*p+E*v,t[7]=y*o+w*c+x*g+E*b,y=r[8],w=r[9],x=r[10],E=r[11],t[8]=y*i+w*a+x*u+E*m,t[9]=y*n+w*h+x*d+E*f,t[10]=y*s+w*l+x*p+E*v,t[11]=y*o+w*c+x*g+E*b,y=r[12],w=r[13],x=r[14],E=r[15],t[12]=y*i+w*a+x*u+E*m,t[13]=y*n+w*h+x*d+E*f,t[14]=y*s+w*l+x*p+E*v,t[15]=y*o+w*c+x*g+E*b,t}class _ extends Array{constructor(t=1,e=0,r=0,i=0,n=0,s=1,o=0,a=0,h=0,l=0,c=1,u=0,d=0,p=0,g=0,m=1){return super(t,e,r,i,n,s,o,a,h,l,c,u,d,p,g,m),this}set x(t){this[12]=t}get x(){return this[12]}set y(t){this[13]=t}get y(){return this[13]}set z(t){this[14]=t}get z(){return this[14]}set w(t){this[15]=t}get w(){return this[15]}set(t,e,r,i,n,s,o,a,h,l,c,u,d,p,g,m){return t.length?this.copy(t):(function(t,e,r,i,n,s,o,a,h,l,c,u,d,p,g,m,f){t[0]=e,t[1]=r,t[2]=i,t[3]=n,t[4]=s,t[5]=o,t[6]=a,t[7]=h,t[8]=l,t[9]=c,t[10]=u,t[11]=d,t[12]=p,t[13]=g,t[14]=m,t[15]=f}(this,t,e,r,i,n,s,o,a,h,l,c,u,d,p,g,m),this)}translate(t,e=this){return function(t,e,r){let i,n,s,o,a,h,l,c,u,d,p,g,m=r[0],f=r[1],v=r[2];e===t?(t[12]=e[0]*m+e[4]*f+e[8]*v+e[12],t[13]=e[1]*m+e[5]*f+e[9]*v+e[13],t[14]=e[2]*m+e[6]*f+e[10]*v+e[14],t[15]=e[3]*m+e[7]*f+e[11]*v+e[15]):(i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],p=e[10],g=e[11],t[0]=i,t[1]=n,t[2]=s,t[3]=o,t[4]=a,t[5]=h,t[6]=l,t[7]=c,t[8]=u,t[9]=d,t[10]=p,t[11]=g,t[12]=i*m+a*f+u*v+e[12],t[13]=n*m+h*f+d*v+e[13],t[14]=s*m+l*f+p*v+e[14],t[15]=o*m+c*f+g*v+e[15])}(this,e,t),this}rotateX(t,e=this){return function(t,e,r){let i=Math.sin(r),n=Math.cos(r),s=e[4],o=e[5],a=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*n+l*i,t[5]=o*n+c*i,t[6]=a*n+u*i,t[7]=h*n+d*i,t[8]=l*n-s*i,t[9]=c*n-o*i,t[10]=u*n-a*i,t[11]=d*n-h*i}(this,e,t),this}rotateY(t,e=this){return function(t,e,r){let i=Math.sin(r),n=Math.cos(r),s=e[0],o=e[1],a=e[2],h=e[3],l=e[8],c=e[9],u=e[10],d=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n-l*i,t[1]=o*n-c*i,t[2]=a*n-u*i,t[3]=h*n-d*i,t[8]=s*i+l*n,t[9]=o*i+c*n,t[10]=a*i+u*n,t[11]=h*i+d*n}(this,e,t),this}rotateZ(t,e=this){return function(t,e,r){let i=Math.sin(r),n=Math.cos(r),s=e[0],o=e[1],a=e[2],h=e[3],l=e[4],c=e[5],u=e[6],d=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*n+l*i,t[1]=o*n+c*i,t[2]=a*n+u*i,t[3]=h*n+d*i,t[4]=l*n-s*i,t[5]=c*n-o*i,t[6]=u*n-a*i,t[7]=d*n-h*i}(this,e,t),this}scale(t,e=this){return function(t,e,r){let i=r[0],n=r[1],s=r[2];t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this,e,"number"==typeof t?[t,t,t]:t),this}multiply(t,e){return e?O(this,t,e):O(this,this,t),this}identity(){return S(this),this}copy(t){var e,r;return r=t,(e=this)[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}fromPerspective({fov:t,aspect:e,near:r,far:i}={}){return function(t,e,r,i,n){let s=1/Math.tan(e/2),o=1/(i-n);t[0]=s/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(n+i)*o,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*n*i*o,t[15]=0}(this,t,e,r,i),this}fromOrthogonal({left:t,right:e,bottom:r,top:i,near:n,far:s}){return function(t,e,r,i,n,s,o){let a=1/(e-r),h=1/(i-n),l=1/(s-o);t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+r)*a,t[13]=(n+i)*h,t[14]=(o+s)*l,t[15]=1}(this,t,e,r,i,n,s),this}fromQuaternion(t){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=r+r,a=i+i,h=n+n,l=r*o,c=i*o,u=i*a,d=n*o,p=n*a,g=n*h,m=s*o,f=s*a,v=s*h;t[0]=1-u-g,t[1]=c+v,t[2]=d-f,t[3]=0,t[4]=c-v,t[5]=1-l-g,t[6]=p+m,t[7]=0,t[8]=d+f,t[9]=p-m,t[10]=1-l-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this,t),this}setPosition(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],p=e[11],g=e[12],m=e[13],f=e[14],v=e[15],b=r*a-i*o,y=r*h-n*o,w=r*l-s*o,x=i*h-n*a,E=i*l-s*a,M=n*l-s*h,A=c*m-u*g,S=c*f-d*g,O=c*v-p*g,_=u*f-d*m,C=u*v-p*m,L=d*v-p*f,P=b*L-y*C+w*_+x*O-E*S+M*A;P&&(P=1/P,t[0]=(a*L-h*C+l*_)*P,t[1]=(n*C-i*L-s*_)*P,t[2]=(m*M-f*E+v*x)*P,t[3]=(d*E-u*M-p*x)*P,t[4]=(h*O-o*L-l*S)*P,t[5]=(r*L-n*O+s*S)*P,t[6]=(f*w-g*M-v*y)*P,t[7]=(c*M-d*w+p*y)*P,t[8]=(o*C-a*O+l*A)*P,t[9]=(i*O-r*C-s*A)*P,t[10]=(g*E-m*w+v*b)*P,t[11]=(u*w-c*E-p*b)*P,t[12]=(a*S-o*_-h*A)*P,t[13]=(r*_-i*S+n*A)*P,t[14]=(m*y-g*x-f*b)*P,t[15]=(c*x-u*y+d*b)*P)}(this,t),this}compose(t,e,r){return function(t,e,r,i){let n=e[0],s=e[1],o=e[2],a=e[3],h=n+n,l=s+s,c=o+o,u=n*h,d=n*l,p=n*c,g=s*l,m=s*c,f=o*c,v=a*h,b=a*l,y=a*c,w=i[0],x=i[1],E=i[2];t[0]=(1-(g+f))*w,t[1]=(d+y)*w,t[2]=(p-b)*w,t[3]=0,t[4]=(d-y)*x,t[5]=(1-(u+f))*x,t[6]=(m+v)*x,t[7]=0,t[8]=(p+b)*E,t[9]=(m-v)*E,t[10]=(1-(u+g))*E,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1}(this,t,e,r),this}getRotation(t){return function(t,e){let r=e[0]+e[5]+e[10],i=0;r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i)}(t,this),this}getTranslation(t){var e,r;return r=this,(e=t)[0]=r[12],e[1]=r[13],e[2]=r[14],this}getScaling(t){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[4],o=e[5],a=e[6],h=e[8],l=e[9],c=e[10];t[0]=Math.sqrt(r*r+i*i+n*n),t[1]=Math.sqrt(s*s+o*o+a*a),t[2]=Math.sqrt(h*h+l*l+c*c)}(t,this),this}getMaxScaleOnAxis(){return function(t){let e=t[0],r=t[1],i=t[2],n=t[4],s=t[5],o=t[6],a=t[8],h=t[9],l=t[10];const c=e*e+r*r+i*i,u=n*n+s*s+o*o,d=a*a+h*h+l*l;return Math.sqrt(Math.max(c,u,d))}(this)}lookAt(t,e,r){return function(t,e,r,i){let n=e[0],s=e[1],o=e[2],a=i[0],h=i[1],l=i[2],c=n-r[0],u=s-r[1],d=o-r[2],p=c*c+u*u+d*d;p>0&&(p=1/Math.sqrt(p),c*=p,u*=p,d*=p);let g=h*d-l*u,m=l*c-a*d,f=a*u-h*c;p=g*g+m*m+f*f,p>0&&(p=1/Math.sqrt(p),g*=p,m*=p,f*=p),t[0]=g,t[1]=m,t[2]=f,t[3]=0,t[4]=u*f-d*m,t[5]=d*g-c*f,t[6]=c*m-u*g,t[7]=0,t[8]=c,t[9]=u,t[10]=d,t[11]=0,t[12]=n,t[13]=s,t[14]=o,t[15]=1}(this,t,e,r),this}determinant(){return function(t){let e=t[0],r=t[1],i=t[2],n=t[3],s=t[4],o=t[5],a=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],p=t[12],g=t[13],m=t[14],f=t[15];return(e*o-r*s)*(u*f-d*m)-(e*a-i*s)*(c*f-d*g)+(e*h-n*s)*(c*m-u*g)+(r*a-i*o)*(l*f-d*p)-(r*h-n*o)*(l*m-u*p)+(i*h-n*a)*(l*g-c*p)}(this)}}function C(t,e,r){r*=.5;let i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function L(t,e,r){let i=e[0],n=e[1],s=e[2],o=e[3],a=r[0],h=r[1],l=r[2],c=r[3];return t[0]=i*c+o*a+n*l-s*h,t[1]=n*c+o*h+s*a-i*l,t[2]=s*c+o*l+i*h-n*a,t[3]=o*c-i*a-n*h-s*l,t}function P(t,e,r,i){let n,s,o,a,h,l=e[0],c=e[1],u=e[2],d=e[3],p=r[0],g=r[1],m=r[2],f=r[3];return s=l*p+c*g+u*m+d*f,s<0&&(s=-s,p=-p,g=-g,m=-m,f=-f),1-s>1e-6?(n=Math.acos(s),o=Math.sin(n),a=Math.sin((1-i)*n)/o,h=Math.sin(i*n)/o):(a=1-i,h=i),t[0]=a*l+h*p,t[1]=a*c+h*g,t[2]=a*u+h*m,t[3]=a*d+h*f,t}function T(t,e){let r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);let n=(i+1)%3,s=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*n+n]-e[3*s+s]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*n+s]-e[3*s+n])*r,t[n]=(e[3*n+i]+e[3*i+n])*r,t[s]=(e[3*s+i]+e[3*i+s])*r}return t}const R=y,F=w,N=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},D=x;(function(){const t=[0,0,0],e=[1,0,0],r=[0,1,0]})(),function(){let t=[0,0,0,1],e=[0,0,0,1]}(),function(){const t=[1,0,0,0,1,0,0,0,1]}();class j extends Array{constructor(t=0,e=0,r=0,i=1){return super(t,e,r,i),this.onChange=()=>{},this}get x(){return this[0]}set x(t){this[0]=t,this.onChange()}get y(){return this[1]}set y(t){this[1]=t,this.onChange()}get z(){return this[2]}set z(t){this[2]=t,this.onChange()}get w(){return this[3]}set w(t){this[3]=t,this.onChange()}identity(){var t;return(t=this)[0]=0,t[1]=0,t[2]=0,t[3]=1,this.onChange(),this}set(t,e,r,i){return t.length?this.copy(t):(F(this,t,e,r,i),this.onChange(),this)}rotateX(t){return function(t,e,r){r*=.5;let i=e[0],n=e[1],s=e[2],o=e[3],a=Math.sin(r),h=Math.cos(r);t[0]=i*h+o*a,t[1]=n*h+s*a,t[2]=s*h-n*a,t[3]=o*h-i*a}(this,this,t),this.onChange(),this}rotateY(t){return function(t,e,r){r*=.5;let i=e[0],n=e[1],s=e[2],o=e[3],a=Math.sin(r),h=Math.cos(r);t[0]=i*h-s*a,t[1]=n*h+o*a,t[2]=s*h+i*a,t[3]=o*h-n*a}(this,this,t),this.onChange(),this}rotateZ(t){return function(t,e,r){r*=.5;let i=e[0],n=e[1],s=e[2],o=e[3],a=Math.sin(r),h=Math.cos(r);t[0]=i*h+n*a,t[1]=n*h-i*a,t[2]=s*h+o*a,t[3]=o*h-s*a}(this,this,t),this.onChange(),this}inverse(t=this){return function(t,e){let r=e[0],i=e[1],n=e[2],s=e[3],o=r*r+i*i+n*n+s*s,a=o?1/o:0;t[0]=-r*a,t[1]=-i*a,t[2]=-n*a,t[3]=s*a}(this,t),this.onChange(),this}conjugate(t=this){var e,r;return r=t,(e=this)[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=r[3],this.onChange(),this}copy(t){return R(this,t),this.onChange(),this}normalize(t=this){return D(this,t),this.onChange(),this}multiply(t,e){return e?L(this,t,e):L(this,this,t),this.onChange(),this}dot(t){return N(this,t)}fromMatrix3(t){return T(this,t),this.onChange(),this}fromEuler(t){return function(t,e,r="YXZ"){let i=Math.sin(.5*e[0]),n=Math.cos(.5*e[0]),s=Math.sin(.5*e[1]),o=Math.cos(.5*e[1]),a=Math.sin(.5*e[2]),h=Math.cos(.5*e[2]);"XYZ"===r?(t[0]=i*o*h+n*s*a,t[1]=n*s*h-i*o*a,t[2]=n*o*a+i*s*h,t[3]=n*o*h-i*s*a):"YXZ"===r?(t[0]=i*o*h+n*s*a,t[1]=n*s*h-i*o*a,t[2]=n*o*a-i*s*h,t[3]=n*o*h+i*s*a):"ZXY"===r?(t[0]=i*o*h-n*s*a,t[1]=n*s*h+i*o*a,t[2]=n*o*a+i*s*h,t[3]=n*o*h-i*s*a):"ZYX"===r?(t[0]=i*o*h-n*s*a,t[1]=n*s*h+i*o*a,t[2]=n*o*a-i*s*h,t[3]=n*o*h+i*s*a):"YZX"===r?(t[0]=i*o*h+n*s*a,t[1]=n*s*h+i*o*a,t[2]=n*o*a-i*s*h,t[3]=n*o*h-i*s*a):"XZY"===r&&(t[0]=i*o*h-n*s*a,t[1]=n*s*h-i*o*a,t[2]=n*o*a+i*s*h,t[3]=n*o*h+i*s*a)}(this,t,t.order),this}fromAxisAngle(t,e){return C(this,t,e),this}slerp(t,e){return P(this,this,t,e),this}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}const I=new _;class B extends Array{constructor(t=0,e=t,r=t,i="YXZ"){return super(t,e,r),this.order=i,this.onChange=()=>{},this}get x(){return this[0]}set x(t){this[0]=t,this.onChange()}get y(){return this[1]}set y(t){this[1]=t,this.onChange()}get z(){return this[2]}set z(t){this[2]=t,this.onChange()}set(t,e=t,r=t){return t.length?this.copy(t):(this[0]=t,this[1]=e,this[2]=r,this.onChange(),this)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.onChange(),this}reorder(t){return this.order=t,this.onChange(),this}fromRotationMatrix(t,e=this.order){return function(t,e,r="YXZ"){"XYZ"===r?(t[1]=Math.asin(Math.min(Math.max(e[8],-1),1)),Math.abs(e[8])<.99999?(t[0]=Math.atan2(-e[9],e[10]),t[2]=Math.atan2(-e[4],e[0])):(t[0]=Math.atan2(e[6],e[5]),t[2]=0)):"YXZ"===r?(t[0]=Math.asin(-Math.min(Math.max(e[9],-1),1)),Math.abs(e[9])<.99999?(t[1]=Math.atan2(e[8],e[10]),t[2]=Math.atan2(e[1],e[5])):(t[1]=Math.atan2(-e[2],e[0]),t[2]=0)):"ZXY"===r?(t[0]=Math.asin(Math.min(Math.max(e[6],-1),1)),Math.abs(e[6])<.99999?(t[1]=Math.atan2(-e[2],e[10]),t[2]=Math.atan2(-e[4],e[5])):(t[1]=0,t[2]=Math.atan2(e[1],e[0]))):"ZYX"===r?(t[1]=Math.asin(-Math.min(Math.max(e[2],-1),1)),Math.abs(e[2])<.99999?(t[0]=Math.atan2(e[6],e[10]),t[2]=Math.atan2(e[1],e[0])):(t[0]=0,t[2]=Math.atan2(-e[4],e[5]))):"YZX"===r?(t[2]=Math.asin(Math.min(Math.max(e[1],-1),1)),Math.abs(e[1])<.99999?(t[0]=Math.atan2(-e[9],e[5]),t[1]=Math.atan2(-e[2],e[0])):(t[0]=0,t[1]=Math.atan2(e[8],e[10]))):"XZY"===r&&(t[2]=Math.asin(-Math.min(Math.max(e[4],-1),1)),Math.abs(e[4])<.99999?(t[0]=Math.atan2(e[6],e[5]),t[1]=Math.atan2(e[8],e[0])):(t[0]=Math.atan2(-e[9],e[10]),t[1]=0))}(this,t,e),this}fromQuaternion(t,e=this.order){return I.fromQuaternion(t),this.fromRotationMatrix(I,e)}}let U=1;const z={};class G{constructor(t,{vertex:e,fragment:r,uniforms:i={},transparent:n=!1,cullFace:s=t.BACK,frontFace:o=t.CCW,depthTest:a=!0,depthWrite:h=!0,depthFunc:l=t.LESS}={}){this.gl=t,this.uniforms=i,this.id=U++,e||console.warn("vertex shader not supplied"),r||console.warn("fragment shader not supplied"),this.transparent=n,this.cullFace=s,this.frontFace=o,this.depthTest=a,this.depthWrite=h,this.depthFunc=l,this.blendFunc={},this.blendEquation={},this.transparent&&!this.blendFunc.src&&(this.gl.renderer.premultipliedAlpha?this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA));const c=t.createShader(t.VERTEX_SHADER);t.shaderSource(c,e),t.compileShader(c),""!==t.getShaderInfoLog(c)&&console.warn(`${t.getShaderInfoLog(c)}\nVertex Shader\n${X(e)}`);const u=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(u,r),t.compileShader(u),""!==t.getShaderInfoLog(u)&&console.warn(`${t.getShaderInfoLog(u)}\nFragment Shader\n${X(r)}`),this.program=t.createProgram(),t.attachShader(this.program,c),t.attachShader(this.program,u),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.warn(t.getProgramInfoLog(this.program));t.deleteShader(c),t.deleteShader(u),this.uniformLocations=new Map;let d=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<d;e++){let r=t.getActiveUniform(this.program,e);this.uniformLocations.set(r,t.getUniformLocation(this.program,r.name));const i=r.name.match(/(\w+)/g);r.uniformName=i[0],3===i.length?(r.isStructArray=!0,r.structIndex=Number(i[1]),r.structProperty=i[2]):2===i.length&&isNaN(Number(i[1]))&&(r.isStruct=!0,r.structProperty=i[1])}this.attributeLocations=new Map;const p=[],g=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<g;e++){const r=t.getActiveAttrib(this.program,e),i=t.getAttribLocation(this.program,r.name);p[i]=r.name,this.attributeLocations.set(r.name,i)}this.attributeOrder=p.join("")}setBlendFunc(t,e,r,i){this.blendFunc.src=t,this.blendFunc.dst=e,this.blendFunc.srcAlpha=r,this.blendFunc.dstAlpha=i,t&&(this.transparent=!0)}setBlendEquation(t,e){this.blendEquation.modeRGB=t,this.blendEquation.modeAlpha=e}applyState(){this.depthTest?this.gl.renderer.enable(this.gl.DEPTH_TEST):this.gl.renderer.disable(this.gl.DEPTH_TEST),this.cullFace?this.gl.renderer.enable(this.gl.CULL_FACE):this.gl.renderer.disable(this.gl.CULL_FACE),this.blendFunc.src?this.gl.renderer.enable(this.gl.BLEND):this.gl.renderer.disable(this.gl.BLEND),this.cullFace&&this.gl.renderer.setCullFace(this.cullFace),this.gl.renderer.setFrontFace(this.frontFace),this.gl.renderer.setDepthMask(this.depthWrite),this.gl.renderer.setDepthFunc(this.depthFunc),this.blendFunc.src&&this.gl.renderer.setBlendFunc(this.blendFunc.src,this.blendFunc.dst,this.blendFunc.srcAlpha,this.blendFunc.dstAlpha),this.blendEquation.modeRGB&&this.gl.renderer.setBlendEquation(this.blendEquation.modeRGB,this.blendEquation.modeAlpha)}use({flipFaces:t=!1}={}){let e=-1;this.gl.renderer.currentProgram===this.id||(this.gl.useProgram(this.program),this.gl.renderer.currentProgram=this.id),this.uniformLocations.forEach((t,r)=>{let i=r.uniformName,n=this.uniforms[i];if(r.isStruct&&(n=n[r.structProperty],i+=`.${r.structProperty}`),r.isStructArray&&(n=n[r.structIndex][r.structProperty],i+=`[${r.structIndex}].${r.structProperty}`),!n)return V(`Active uniform ${i} has not been supplied`);if(n&&void 0===n.value)return V(`${i} uniform is missing a value parameter`);if(n.value.texture)return e+=1,n.value.update(e),k(this.gl,r.type,t,e);if(n.value.length&&n.value[0].texture){const i=[];return n.value.forEach(t=>{e+=1,t.update(e),i.push(e)}),k(this.gl,r.type,t,i)}k(this.gl,r.type,t,n.value)}),this.applyState(),t&&this.gl.renderer.setFrontFace(this.frontFace===this.gl.CCW?this.gl.CW:this.gl.CCW)}remove(){this.gl.deleteProgram(this.program)}}function k(t,e,r,i){i=i.length?function(t){const e=t.length,r=t[0].length;if(void 0===r)return t;const i=e*r;let n=z[i];n||(z[i]=n=new Float32Array(i));for(let i=0;i<e;i++)n.set(t[i],i*r);return n}(i):i;const n=t.renderer.state.uniformLocations.get(r);if(i.length)if(void 0===n)t.renderer.state.uniformLocations.set(r,i.slice(0));else{if(function(t,e){if(t.length!==e.length)return!1;for(let r=0,i=t.length;r<i;r++)if(t[r]!==e[r])return!1;return!0}(n,i))return;n.set?n.set(i):function(t,e){for(let r=0,i=t.length;r<i;r++)t[r]=e[r]}(n,i),t.renderer.state.uniformLocations.set(r,n)}else{if(n===i)return;t.renderer.state.uniformLocations.set(r,i)}switch(e){case 5126:return i.length?t.uniform1fv(r,i):t.uniform1f(r,i);case 35664:return t.uniform2fv(r,i);case 35665:return t.uniform3fv(r,i);case 35666:return t.uniform4fv(r,i);case 35670:case 5124:case 35678:case 35680:return i.length?t.uniform1iv(r,i):t.uniform1i(r,i);case 35671:case 35667:return t.uniform2iv(r,i);case 35672:case 35668:return t.uniform3iv(r,i);case 35673:case 35669:return t.uniform4iv(r,i);case 35674:return t.uniformMatrix2fv(r,!1,i);case 35675:return t.uniformMatrix3fv(r,!1,i);case 35676:return t.uniformMatrix4fv(r,!1,i)}}function X(t){let e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}let Y=0;function V(t){Y>100||(console.warn(t),Y++,Y>100&&console.warn("More than 100 program warnings - stopping logs."))}class q{constructor(){this.parent=null,this.children=[],this.visible=!0,this.matrix=new _,this.worldMatrix=new _,this.matrixAutoUpdate=!0,this.position=new b,this.quaternion=new j,this.scale=new b(1),this.rotation=new B,this.up=new b(0,1,0),this.rotation.onChange=()=>this.quaternion.fromEuler(this.rotation),this.quaternion.onChange=()=>this.rotation.fromQuaternion(this.quaternion)}setParent(t,e=!0){e&&this.parent&&t!==this.parent&&this.parent.removeChild(this,!1),this.parent=t,e&&t&&t.addChild(this,!1)}addChild(t,e=!0){~this.children.indexOf(t)||this.children.push(t),e&&t.setParent(this,!1)}removeChild(t,e=!0){~this.children.indexOf(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||t)&&(null===this.parent?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,t=!0);for(let e=0,r=this.children.length;e<r;e++)this.children[e].updateMatrixWorld(t)}updateMatrix(){this.matrix.compose(this.quaternion,this.position,this.scale),this.worldMatrixNeedsUpdate=!0}traverse(t){if(!t(this))for(let e=0,r=this.children.length;e<r;e++)this.children[e].traverse(t)}decompose(){this.matrix.getTranslation(this.position),this.matrix.getRotation(this.quaternion),this.matrix.getScaling(this.scale),this.rotation.fromQuaternion(this.quaternion)}lookAt(t,e=!1){e?this.matrix.lookAt(this.position,t,this.up):this.matrix.lookAt(t,this.position,this.up),this.matrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}}let H=0;class W extends q{constructor(t,{geometry:e,program:r,mode:i=t.TRIANGLES,frustumCulled:n=!0,renderOrder:s=0}={}){super(),this.gl=t,this.id=H++,this.geometry=e,this.program=r,this.mode=i,this.frustumCulled=n,this.renderOrder=s,this.modelViewMatrix=new _,this.normalMatrix=new A,this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[]}onBeforeRender(t){return this.beforeRenderCallbacks.push(t),this}onAfterRender(t){return this.afterRenderCallbacks.push(t),this}draw({camera:t}={}){this.beforeRenderCallbacks.forEach(e=>e&&e({mesh:this,camera:t})),t&&(this.program.uniforms.modelMatrix||Object.assign(this.program.uniforms,{modelMatrix:{value:null},viewMatrix:{value:null},modelViewMatrix:{value:null},normalMatrix:{value:null},projectionMatrix:{value:null},cameraPosition:{value:null}}),this.program.uniforms.projectionMatrix.value=t.projectionMatrix,this.program.uniforms.cameraPosition.value=t.worldPosition,this.program.uniforms.viewMatrix.value=t.viewMatrix,this.modelViewMatrix.multiply(t.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix),this.program.uniforms.modelMatrix.value=this.worldMatrix,this.program.uniforms.modelViewMatrix.value=this.modelViewMatrix,this.program.uniforms.normalMatrix.value=this.normalMatrix);let e=this.program.cullFace&&this.worldMatrix.determinant()<0;this.program.use({flipFaces:e}),this.geometry.draw({mode:this.mode,program:this.program}),this.afterRenderCallbacks.forEach(e=>e&&e({mesh:this,camera:t}))}}const Z=new Uint8Array(4);function $(t){return 0==(t&t-1)}let Q=1;class K{constructor(t,{image:e,target:r=t.TEXTURE_2D,type:i=t.UNSIGNED_BYTE,format:n=t.RGBA,internalFormat:s=n,wrapS:o=t.CLAMP_TO_EDGE,wrapT:a=t.CLAMP_TO_EDGE,generateMipmaps:h=!0,minFilter:l=(h?t.NEAREST_MIPMAP_LINEAR:t.LINEAR),magFilter:c=t.LINEAR,premultiplyAlpha:u=!1,unpackAlignment:d=4,flipY:p=r==t.TEXTURE_2D,anisotropy:g=0,level:m=0,width:f,height:v=f}={}){this.gl=t,this.id=Q++,this.image=e,this.target=r,this.type=i,this.format=n,this.internalFormat=s,this.minFilter=l,this.magFilter=c,this.wrapS=o,this.wrapT=a,this.generateMipmaps=h,this.premultiplyAlpha=u,this.unpackAlignment=d,this.flipY=p,this.anisotropy=Math.min(g,this.gl.renderer.parameters.maxAnisotropy),this.level=m,this.width=f,this.height=v,this.texture=this.gl.createTexture(),this.store={image:null},this.glState=this.gl.renderer.state,this.state={},this.state.minFilter=this.gl.NEAREST_MIPMAP_LINEAR,this.state.magFilter=this.gl.LINEAR,this.state.wrapS=this.gl.REPEAT,this.state.wrapT=this.gl.REPEAT,this.state.anisotropy=0}bind(){this.glState.textureUnits[this.glState.activeTextureUnit]!==this.id&&(this.gl.bindTexture(this.target,this.texture),this.glState.textureUnits[this.glState.activeTextureUnit]=this.id)}update(t=0){const e=!(this.image===this.store.image&&!this.needsUpdate);if((e||this.glState.textureUnits[t]!==this.id)&&(this.gl.renderer.activeTexture(t),this.bind()),e){if(this.needsUpdate=!1,this.flipY!==this.glState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.glState.flipY=this.flipY),this.premultiplyAlpha!==this.glState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.glState.premultiplyAlpha=this.premultiplyAlpha),this.unpackAlignment!==this.glState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.unpackAlignment),this.glState.unpackAlignment=this.unpackAlignment),this.minFilter!==this.state.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.minFilter),this.state.minFilter=this.minFilter),this.magFilter!==this.state.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.magFilter),this.state.magFilter=this.magFilter),this.wrapS!==this.state.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.wrapS),this.state.wrapS=this.wrapS),this.wrapT!==this.state.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.wrapT),this.state.wrapT=this.wrapT),this.anisotropy&&this.anisotropy!==this.state.anisotropy&&(this.gl.texParameterf(this.target,this.gl.renderer.getExtension("EXT_texture_filter_anisotropic").TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropy),this.state.anisotropy=this.anisotropy),this.image){if(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.level,this.internalFormat,this.format,this.type,this.image[t]);else if(ArrayBuffer.isView(this.image))this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,this.image);else if(this.image.isCompressedTexture)for(let t=0;t<this.image.length;t++)this.gl.compressedTexImage2D(this.target,t,this.internalFormat,this.image[t].width,this.image[t].height,0,this.image[t].data);else this.gl.texImage2D(this.target,this.level,this.internalFormat,this.format,this.type,this.image);this.generateMipmaps&&(this.gl.renderer.isWebgl2||$(this.image.width)&&$(this.image.height)?this.gl.generateMipmap(this.target):(this.generateMipmaps=!1,this.wrapS=this.wrapT=this.gl.CLAMP_TO_EDGE,this.minFilter=this.gl.LINEAR)),this.onUpdate&&this.onUpdate()}else if(this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Z);else this.width?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Z);this.store.image=this.image}}}class J{constructor(t,{width:e=t.canvas.width,height:r=t.canvas.height,target:i=t.FRAMEBUFFER,color:n=1,depth:s=!0,stencil:o=!1,depthTexture:a=!1,wrapS:h=t.CLAMP_TO_EDGE,wrapT:l=t.CLAMP_TO_EDGE,minFilter:c=t.LINEAR,magFilter:u=c,type:d=t.UNSIGNED_BYTE,format:p=t.RGBA,internalFormat:g=p,unpackAlignment:m,premultiplyAlpha:f}={}){this.gl=t,this.width=e,this.height=r,this.depth=s,this.buffer=this.gl.createFramebuffer(),this.target=i,this.gl.bindFramebuffer(this.target,this.buffer),this.textures=[];const v=[];for(let i=0;i<n;i++)this.textures.push(new K(t,{width:e,height:r,wrapS:h,wrapT:l,minFilter:c,magFilter:u,type:d,format:p,internalFormat:g,unpackAlignment:m,premultiplyAlpha:f,flipY:!1,generateMipmaps:!1})),this.textures[i].update(),this.gl.framebufferTexture2D(this.target,this.gl.COLOR_ATTACHMENT0+i,this.gl.TEXTURE_2D,this.textures[i].texture,0),v.push(this.gl.COLOR_ATTACHMENT0+i);v.length>1&&this.gl.renderer.drawBuffers(v),this.texture=this.textures[0],a&&(this.gl.renderer.isWebgl2||this.gl.renderer.getExtension("WEBGL_depth_texture"))?(this.depthTexture=new K(t,{width:e,height:r,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,format:this.gl.DEPTH_COMPONENT,internalFormat:t.renderer.isWebgl2?this.gl.DEPTH_COMPONENT16:this.gl.DEPTH_COMPONENT,type:this.gl.UNSIGNED_INT}),this.depthTexture.update(),this.gl.framebufferTexture2D(this.target,this.gl.DEPTH_ATTACHMENT,this.gl.TEXTURE_2D,this.depthTexture.texture,0)):(s&&!o&&(this.depthBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,r),this.gl.framebufferRenderbuffer(this.target,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer)),o&&!s&&(this.stencilBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.stencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,e,r),this.gl.framebufferRenderbuffer(this.target,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,this.stencilBuffer)),s&&o&&(this.depthStencilBuffer=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthStencilBuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_STENCIL,e,r),this.gl.framebufferRenderbuffer(this.target,this.gl.DEPTH_STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,this.depthStencilBuffer))),this.gl.bindFramebuffer(this.target,null)}}const tt=new b;let et=1,rt=1;class it{constructor(t,e={}){this.gl=t,this.attributes=e,this.id=et++,this.VAOs={},this.drawRange={start:0,count:0},this.instancedCount=0,this.gl.renderer.bindVertexArray(null),this.gl.renderer.currentGeometry=null,this.glState=this.gl.renderer.state;for(let t in e)this.addAttribute(t,e[t])}addAttribute(t,e){if(this.attributes[t]=e,e.id=rt++,e.size=e.size||1,e.type=e.type||(e.data.constructor===Float32Array?this.gl.FLOAT:e.data.constructor===Uint16Array?this.gl.UNSIGNED_SHORT:this.gl.UNSIGNED_INT),e.target="index"===t?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER,e.normalize=e.normalize||!1,e.buffer=this.gl.createBuffer(),e.count=e.data.length/e.size,e.divisor=e.instanced||0,e.needsUpdate=!1,this.updateAttribute(e),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return console.warn("geometry has multiple instanced buffers of different length"),this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor);this.instancedCount=e.count*e.divisor}else"index"===t?this.drawRange.count=e.count:this.attributes.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}updateAttribute(t){this.glState.boundBuffer!==t.id&&(this.gl.bindBuffer(t.target,t.buffer),this.glState.boundBuffer=t.id),this.gl.bufferData(t.target,t.data,this.gl.STATIC_DRAW),t.needsUpdate=!1}setIndex(t){this.addAttribute("index",t)}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){this.VAOs[t.attributeOrder]=this.gl.renderer.createVertexArray(),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach((t,e)=>{if(!this.attributes[e])return void console.warn(`active attribute ${e} not being supplied`);const r=this.attributes[e];this.gl.bindBuffer(r.target,r.buffer),this.glState.boundBuffer=r.id,this.gl.vertexAttribPointer(t,r.size,r.type,r.normalize,0,0),this.gl.enableVertexAttribArray(t),this.gl.renderer.vertexAttribDivisor(t,r.divisor)}),this.attributes.index&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.attributes.index.buffer)}draw({program:t,mode:e=this.gl.TRIANGLES}){this.gl.renderer.currentGeometry!==`${this.id}_${t.attributeOrder}`&&(this.VAOs[t.attributeOrder]||this.createVAO(t),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.gl.renderer.currentGeometry=`${this.id}_${t.attributeOrder}`),t.attributeLocations.forEach((t,e)=>{const r=this.attributes[e];r.needsUpdate&&this.updateAttribute(r)}),this.isInstanced?this.attributes.index?this.gl.renderer.drawElementsInstanced(e,this.drawRange.count,this.attributes.index.type,this.drawRange.start,this.instancedCount):this.gl.renderer.drawArraysInstanced(e,this.drawRange.start,this.drawRange.count,this.instancedCount):this.attributes.index?this.gl.drawElements(e,this.drawRange.count,this.attributes.index.type,this.drawRange.start):this.gl.drawArrays(e,this.drawRange.start,this.drawRange.count)}computeBoundingBox(t){!t&&this.attributes.position&&(t=this.attributes.position.data),t||console.warn("No position buffer found to compute bounds"),this.bounds||(this.bounds={min:new b,max:new b,center:new b,scale:new b,radius:1/0});const e=this.bounds.min,r=this.bounds.max,i=this.bounds.center,n=this.bounds.scale;e.set(1/0),r.set(-1/0);for(let i=0,n=t.length;i<n;i+=3){const n=t[i],s=t[i+1],o=t[i+2];e.x=Math.min(n,e.x),e.y=Math.min(s,e.y),e.z=Math.min(o,e.z),r.x=Math.max(n,r.x),r.y=Math.max(s,r.y),r.z=Math.max(o,r.z)}n.sub(r,e),i.add(e,r).divide(2)}computeBoundingSphere(t){!t&&this.attributes.position&&(t=this.attributes.position.data),t||console.warn("No position buffer found to compute bounds"),this.bounds||this.computeBoundingBox(t);let e=0;for(let r=0,i=t.length;r<i;r+=3)tt.fromArray(t,r),e=Math.max(e,this.bounds.center.squaredDistance(tt));this.bounds.radius=Math.sqrt(e)}remove(){this.vao&&this.gl.renderer.deleteVertexArray(this.vao);for(let t in this.attributes)this.gl.deleteBuffer(this.attributes[t].buffer),delete this.attributes[t]}}class nt extends it{constructor(t,{attributes:e={}}={}){Object.assign(e,{position:{size:2,data:new Float32Array([-1,-1,3,-1,-1,3])},uv:{size:2,data:new Float32Array([0,0,2,0,0,2])}}),super(t,e)}}class st{constructor(t,{data:e=new Float32Array(16),geometry:r=new nt(t)}){this.gl=t;const i=e;this.passes=[],this.geometry=r,this.dataLength=i.length/4,this.size=Math.pow(2,Math.ceil(Math.log(Math.ceil(Math.sqrt(this.dataLength)))/Math.LN2)),this.coords=new Float32Array(2*this.dataLength);for(let t=0;t<this.dataLength;t++){const e=t%this.size/this.size,r=Math.floor(t/this.size)/this.size;this.coords.set([e,r],2*t)}const n=(()=>{if(i.length===this.size*this.size*4)return i;{const t=new Float32Array(this.size*this.size*4);return t.set(i),t}})();this.uniform={value:new K(t,{image:n,target:t.TEXTURE_2D,type:t.FLOAT,format:t.RGBA,internalFormat:t.renderer.isWebgl2?t.RGBA32F:t.RGBA,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,generateMipmaps:!1,minFilter:t.NEAREST,magFilter:t.NEAREST,width:this.size,flipY:!1})};const s={width:this.size,height:this.size,type:t.renderer.isWebgl2?t.HALF_FLOAT:t.renderer.extensions.OES_texture_half_float?t.renderer.extensions.OES_texture_half_float.HALF_FLOAT_OES:t.UNSIGNED_BYTE,format:t.RGBA,internalFormat:t.renderer.isWebgl2?t.RGBA16F:t.RGBA,minFilter:t.NEAREST,depth:!1,unpackAlignment:1};this.fbo={read:new J(t,s),write:new J(t,s),swap:()=>{let t=this.fbo.read;this.fbo.read=this.fbo.write,this.fbo.write=t,this.uniform.value=this.fbo.read.texture}}}addPass({vertex:t=ot,fragment:e=at,uniforms:r={},textureUniform:i="tMap",enabled:n=!0}={}){r[i]=this.uniform;const s=new G(this.gl,{vertex:t,fragment:e,uniforms:r}),o={mesh:new W(this.gl,{geometry:this.geometry,program:s}),program:s,uniforms:r,enabled:n,textureUniform:i};return this.passes.push(o),o}render(){this.passes.filter(t=>t.enabled).forEach((t,e)=>{this.gl.renderer.render({scene:t.mesh,target:this.fbo.write,clear:!1}),this.fbo.swap()})}}const ot="\n    attribute vec2 uv;\n    attribute vec2 position;\n\n    varying vec2 vUv;\n\n    void main() {\n        vUv = uv;\n        gl_Position = vec4(position, 0, 1);\n    }\n",at="\n    precision highp float;\n\n    uniform sampler2D tMap;\n    varying vec2 vUv;\n\n    void main() {\n        gl_FragColor = texture2D(tMap, vUv);\n    }\n";var ht=r(0);const lt=new b;class ct{constructor({canvas:t=document.createElement("canvas"),width:e=300,height:r=150,dpr:i=1,alpha:n=!1,depth:s=!0,stencil:o=!1,antialias:a=!1,premultipliedAlpha:h=!1,preserveDrawingBuffer:l=!1,powerPreference:c="default",autoClear:u=!0,webgl:d=2}={}){const p={alpha:n,depth:s,stencil:o,antialias:a,premultipliedAlpha:h,preserveDrawingBuffer:l,powerPreference:c};this.dpr=i,this.alpha=n,this.color=!0,this.depth=s,this.stencil=o,this.premultipliedAlpha=h,this.autoClear=u,2===d&&(this.gl=t.getContext("webgl2",p)),this.isWebgl2=!!this.gl,this.gl||(this.gl=t.getContext("webgl",p)||t.getContext("experimental-webgl",p)),this.gl.renderer=this,this.setSize(e,r),this.state={},this.state.blendFunc={src:this.gl.ONE,dst:this.gl.ZERO},this.state.blendEquation={modeRGB:this.gl.FUNC_ADD},this.state.cullFace=null,this.state.frontFace=this.gl.CCW,this.state.depthMask=!0,this.state.depthFunc=this.gl.LESS,this.state.premultiplyAlpha=!1,this.state.flipY=!1,this.state.unpackAlignment=4,this.state.framebuffer=null,this.state.viewport={width:null,height:null},this.state.textureUnits=[],this.state.activeTextureUnit=0,this.state.boundBuffer=null,this.state.uniformLocations=new Map,this.extensions={},this.isWebgl2?(this.getExtension("EXT_color_buffer_float"),this.getExtension("OES_texture_float_linear")):(this.getExtension("OES_texture_float"),this.getExtension("OES_texture_float_linear"),this.getExtension("OES_texture_half_float"),this.getExtension("OES_texture_half_float_linear"),this.getExtension("OES_element_index_uint"),this.getExtension("OES_standard_derivatives"),this.getExtension("EXT_sRGB"),this.getExtension("WEBGL_depth_texture"),this.getExtension("WEBGL_draw_buffers")),this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),this.drawBuffers=this.getExtension("WEBGL_draw_buffers","drawBuffers","drawBuffersWEBGL"),this.parameters={},this.parameters.maxTextureUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.parameters.maxAnisotropy=this.getExtension("EXT_texture_filter_anisotropic")?this.gl.getParameter(this.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.dpr,this.gl.canvas.height=e*this.dpr,Object.assign(this.gl.canvas.style,{width:t+"px",height:e+"px"})}setViewport(t,e){this.state.viewport.width===t&&this.state.viewport.height===e||(this.state.viewport.width=t,this.state.viewport.height=e,this.gl.viewport(0,0,t,e))}enable(t){!0!==this.state[t]&&(this.gl.enable(t),this.state[t]=!0)}disable(t){!1!==this.state[t]&&(this.gl.disable(t),this.state[t]=!1)}setBlendFunc(t,e,r,i){this.state.blendFunc.src===t&&this.state.blendFunc.dst===e&&this.state.blendFunc.srcAlpha===r&&this.state.blendFunc.dstAlpha===i||(this.state.blendFunc.src=t,this.state.blendFunc.dst=e,this.state.blendFunc.srcAlpha=r,this.state.blendFunc.dstAlpha=i,void 0!==r?this.gl.blendFuncSeparate(t,e,r,i):this.gl.blendFunc(t,e))}setBlendEquation(t,e){this.state.blendEquation.modeRGB===t&&this.state.blendEquation.modeAlpha===e||(this.state.blendEquation.modeRGB=t,this.state.blendEquation.modeAlpha=e,void 0!==e?this.gl.blendEquationSeparate(t,e):this.gl.blendEquation(t))}setCullFace(t){this.state.cullFace!==t&&(this.state.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.state.frontFace!==t&&(this.state.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.state.depthMask!==t&&(this.state.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.state.depthFunc!==t&&(this.state.depthFunc=t,this.gl.depthFunc(t))}activeTexture(t){this.state.activeTextureUnit!==t&&(this.state.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}bindFramebuffer({target:t=this.gl.FRAMEBUFFER,buffer:e=null}={}){this.state.framebuffer!==e&&(this.state.framebuffer=e,this.gl.bindFramebuffer(t,e))}getExtension(t,e,r){return e&&this.gl[e]?this.gl[e].bind(this.gl):(this.extensions[t]||(this.extensions[t]=this.gl.getExtension(t)),e?this.extensions[t]?this.extensions[t][r].bind(this.extensions[t]):null:this.extensions[t])}sortOpaque(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:t.zDepth!==e.zDepth?t.zDepth-e.zDepth:e.id-t.id}sortTransparent(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.zDepth!==e.zDepth?e.zDepth-t.zDepth:e.id-t.id}sortUI(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:e.id-t.id}getRenderList({scene:t,camera:e,frustumCull:r,sort:i}){let n=[];if(e&&r&&e.updateFrustum(),t.traverse(t=>{if(!t.visible)return!0;t.draw&&(r&&t.frustumCulled&&e&&!e.frustumIntersectsMesh(t)||n.push(t))}),i){const t=[],r=[],i=[];n.forEach(n=>{n.program.transparent?n.program.depthTest?r.push(n):i.push(n):t.push(n),n.zDepth=0,0===n.renderOrder&&n.program.depthTest&&e&&(n.worldMatrix.getTranslation(lt),lt.applyMatrix4(e.projectionViewMatrix),n.zDepth=lt.z)}),t.sort(this.sortOpaque),r.sort(this.sortTransparent),i.sort(this.sortUI),n=t.concat(r,i)}return n}render({scene:t,camera:e,target:r=null,update:i=!0,sort:n=!0,frustumCull:s=!0,clear:o}){null===r?(this.bindFramebuffer(),this.setViewport(this.width*this.dpr,this.height*this.dpr)):(this.bindFramebuffer(r),this.setViewport(r.width,r.height)),(o||this.autoClear&&!1!==o)&&(!this.depth||r&&!r.depth||(this.enable(this.gl.DEPTH_TEST),this.setDepthMask(!0)),this.gl.clear((this.color?this.gl.COLOR_BUFFER_BIT:0)|(this.depth?this.gl.DEPTH_BUFFER_BIT:0)|(this.stencil?this.gl.STENCIL_BUFFER_BIT:0))),i&&t.updateMatrixWorld(),e&&e.updateMatrixWorld(),this.getRenderList({scene:t,camera:e,frustumCull:s,sort:n}).forEach(t=>{t.draw({camera:e})})}}class ut{constructor(t,{width:e,height:r,dpr:i,wrapS:n=t.CLAMP_TO_EDGE,wrapT:s=t.CLAMP_TO_EDGE,minFilter:o=t.LINEAR,magFilter:a=t.LINEAR,geometry:h=new nt(t),targetOnly:l=null}={}){this.gl=t,this.options={wrapS:n,wrapT:s,minFilter:o,magFilter:a},this.passes=[],this.geometry=h,this.uniform={value:null},this.targetOnly=l;const c=this.fbo={read:null,write:null,swap:()=>{let t=c.read;c.read=c.write,c.write=t}};this.resize({width:e,height:r,dpr:i})}addPass({vertex:t=dt,fragment:e=pt,uniforms:r={},textureUniform:i="tMap",enabled:n=!0}={}){r[i]={value:this.fbo.read.texture};const s=new G(this.gl,{vertex:t,fragment:e,uniforms:r}),o={mesh:new W(this.gl,{geometry:this.geometry,program:s}),program:s,uniforms:r,enabled:n,textureUniform:i};return this.passes.push(o),o}resize({width:t,height:e,dpr:r}={}){r&&(this.dpr=r),t&&(this.width=t,this.height=e||t),r=this.dpr||this.gl.renderer.dpr,t=(this.width||this.gl.renderer.width)*r,e=(this.height||this.gl.renderer.height)*r,this.options.width=t,this.options.height=e,this.fbo.read=new J(this.gl,this.options),this.fbo.write=new J(this.gl,this.options)}render({scene:t,camera:e,target:r=null,update:i=!0,sort:n=!0,frustumCull:s=!0}){const o=this.passes.filter(t=>t.enabled);this.gl.renderer.render({scene:t,camera:e,target:o.length||!r&&this.targetOnly?this.fbo.write:r,update:i,sort:n,frustumCull:s}),this.fbo.swap(),o.forEach((t,e)=>{t.mesh.program.uniforms[t.textureUniform].value=this.fbo.read.texture,this.gl.renderer.render({scene:t.mesh,target:e!==o.length-1||!r&&this.targetOnly?this.fbo.write:r,clear:e===o.length-1}),this.fbo.swap()}),this.uniform.value=this.fbo.read.texture}}const dt="\n    attribute vec2 uv;\n    attribute vec2 position;\n\n    varying vec2 vUv;\n\n    void main() {\n        vUv = uv;\n        gl_Position = vec4(position, 0, 1);\n    }\n",pt="\n    precision highp float;\n\n    uniform sampler2D tMap;\n    varying vec2 vUv;\n\n    void main() {\n        gl_FragColor = texture2D(tMap, vUv);\n    }\n",gt={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,DOLLY_PAN:3},mt=new b,ft=new h,vt=new h;function bt(t,{element:e=document,enabled:r=!0,target:i=new b,ease:n=.25,inertia:s=.85,enableRotate:o=!0,rotateSpeed:a=.1,enableZoom:l=!0,zoomSpeed:c=1,enablePan:u=!0,panSpeed:d=.1,minPolarAngle:p=0,maxPolarAngle:g=Math.PI,minAzimuthAngle:m=-1/0,maxAzimuthAngle:f=1/0,minDistance:v=0,maxDistance:y=1/0}={}){this.enabled=r,this.target=i,n=n||1,s=s||1,this.minDistance=v,this.maxDistance=y;const w={radius:1,phi:0,theta:0},x={radius:1,phi:0,theta:0},E={radius:1,phi:0,theta:0},M=new b,A=new b;A.copy(t.position).sub(this.target),E.radius=x.radius=A.distance(),E.theta=x.theta=Math.atan2(A.x,A.z),E.phi=x.phi=Math.acos(Math.min(Math.max(A.y/x.radius,-1),1)),this.update=()=>{x.radius*=w.radius,x.theta+=w.theta,x.phi+=w.phi,x.theta=Math.max(m,Math.min(f,x.theta)),x.phi=Math.max(p,Math.min(g,x.phi)),x.radius=Math.max(this.minDistance,Math.min(this.maxDistance,x.radius)),E.phi+=(x.phi-E.phi)*n,E.theta+=(x.theta-E.theta)*n,E.radius+=(x.radius-E.radius)*n,this.target.add(M);let e=E.radius*Math.sin(Math.max(1e-6,E.phi));A.x=e*Math.sin(E.theta),A.y=E.radius*Math.cos(E.phi),A.z=e*Math.cos(E.theta),t.position.copy(this.target).add(A),t.lookAt(this.target),w.theta*=s,w.phi*=s,M.multiply(s),w.radius=1};const S=new h,O=new h,_=new h;let C=gt.NONE;function L(){return Math.pow(.95,c)}this.mouseButtons={ORBIT:0,ZOOM:1,PAN:2};const P=(r,i)=>{let n=e===document?document.body:e;mt.copy(t.position).sub(this.target);let s=mt.distance();s*=Math.tan((t.fov||45)/2*Math.PI/180),function(t,e){mt.set(e[0],e[1],e[2]),mt.multiply(-t),M.add(mt)}(2*r*s/n.clientHeight,t.matrix),function(t,e){mt.set(e[4],e[5],e[6]),mt.multiply(t),M.add(mt)}(2*i*s/n.clientHeight,t.matrix)};function T(t){w.radius/=t}function R(t,r){ft.set(t,r),vt.sub(ft,S).multiply(a);let i=e===document?document.body:e;w.theta-=2*Math.PI*vt.x/i.clientHeight,w.phi-=2*Math.PI*vt.y/i.clientHeight,S.copy(ft)}function F(t,e){ft.set(t,e),vt.sub(ft,O).multiply(d),P(vt.x,vt.y),O.copy(ft)}const N=t=>{if(this.enabled){switch(t.button){case this.mouseButtons.ORBIT:if(!1===o)return;S.set(t.clientX,t.clientY),C=gt.ROTATE;break;case this.mouseButtons.ZOOM:if(!1===l)return;_.set(t.clientX,t.clientY),C=gt.DOLLY;break;case this.mouseButtons.PAN:if(!1===u)return;O.set(t.clientX,t.clientY),C=gt.PAN}C!==gt.NONE&&(window.addEventListener("mousemove",D,!1),window.addEventListener("mouseup",j,!1))}},D=t=>{if(this.enabled)switch(C){case gt.ROTATE:if(!1===o)return;R(t.clientX,t.clientY);break;case gt.DOLLY:if(!1===l)return;!function(t){ft.set(t.clientX,t.clientY),vt.sub(ft,_),vt.y>0?T(L()):vt.y<0&&T(1/L()),_.copy(ft)}(t);break;case gt.PAN:if(!1===u)return;F(t.clientX,t.clientY)}},j=()=>{this.enabled&&(document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",j,!1),C=gt.NONE)},I=t=>{this.enabled&&l&&(C===gt.NONE||C===gt.ROTATE)&&(t.stopPropagation(),t.preventDefault(),t.deltaY<0?T(1/L()):t.deltaY>0&&T(L()))},B=t=>{if(this.enabled)switch(t.preventDefault(),t.touches.length){case 1:if(!1===o)return;S.set(t.touches[0].pageX,t.touches[0].pageY),C=gt.ROTATE;break;case 2:if(!1===l&&!1===u)return;!function(t){if(l){let e=t.touches[0].pageX-t.touches[1].pageX,r=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(e*e+r*r);_.set(0,i)}if(u){let e=.5*(t.touches[0].pageX+t.touches[1].pageX),r=.5*(t.touches[0].pageY+t.touches[1].pageY);O.set(e,r)}}(t),C=gt.DOLLY_PAN;break;default:C=gt.NONE}},U=t=>{if(this.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(!1===o)return;R(t.touches[0].pageX,t.touches[0].pageY);break;case 2:if(!1===l&&!1===u)return;!function(t){if(l){let e=t.touches[0].pageX-t.touches[1].pageX,r=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(e*e+r*r);ft.set(0,i),vt.set(0,Math.pow(ft.y/_.y,c)),T(vt.y),_.copy(ft)}if(u){F(.5*(t.touches[0].pageX+t.touches[1].pageX),.5*(t.touches[0].pageY+t.touches[1].pageY))}}(t);break;default:C=gt.NONE}},z=()=>{this.enabled&&(C=gt.NONE)},G=t=>{this.enabled&&t.preventDefault()};this.remove=function(){e.removeEventListener("contextmenu",G),e.removeEventListener("mousedown",N),e.removeEventListener("wheel",I),e.removeEventListener("touchstart",B),e.removeEventListener("touchend",z),e.removeEventListener("touchmove",U),window.removeEventListener("mousemove",D),window.removeEventListener("mouseup",j)},e.addEventListener("contextmenu",G,!1),e.addEventListener("mousedown",N,!1),e.addEventListener("wheel",I,{passive:!1}),e.addEventListener("touchstart",B,{passive:!1}),e.addEventListener("touchend",z,!1),e.addEventListener("touchmove",U,{passive:!1})}const yt=new b,wt=new b,xt=new b,Et=new _;class Mt{constructor(t){this.gl=t,this.origin=new b,this.direction=new b}castMouse(t,e=[0,0]){t.worldMatrix.getTranslation(this.origin),this.direction.set(e[0],e[1],.5),t.unproject(this.direction),this.direction.sub(this.origin).normalize()}intersectBounds(t){Array.isArray(t)||(t=[t]);const e=Et,r=yt,i=wt,n=[];return t.forEach(t=>{t.geometry.bounds||t.geometry.computeBoundingBox(),"sphere"===t.geometry.raycast&&t.geometry.bounds.radius===1/0&&t.geometry.computeBoundingSphere(),e.inverse(t.worldMatrix),r.copy(this.origin).applyMatrix4(e),i.copy(this.direction).transformDirection(e);let s=0;s="sphere"===t.geometry.raycast?this.intersectSphere(t.geometry.bounds,r,i):this.intersectBox(t.geometry.bounds,r,i),s&&(t.hit||(t.hit={localPoint:new b}),t.hit.distance=s,t.hit.localPoint.copy(i).multiply(s).add(r),n.push(t))}),n.sort((t,e)=>t.hit.distance-e.hit.distance),n}intersectSphere(t,e=this.origin,r=this.direction){const i=xt;i.sub(t.center,e);const n=i.dot(r),s=i.dot(i)-n*n,o=t.radius*t.radius;if(s>o)return 0;const a=Math.sqrt(o-s),h=n-a,l=n+a;return h<0&&l<0?0:h<0?l:h}intersectBox(t,e=this.origin,r=this.direction){let i,n,s,o,a,h;const l=1/r.x,c=1/r.y,u=1/r.z,d=t.min,p=t.max;return i=((l>=0?d.x:p.x)-e.x)*l,n=((l>=0?p.x:d.x)-e.x)*l,s=((c>=0?d.y:p.y)-e.y)*c,o=((c>=0?p.y:d.y)-e.y)*c,i>o||s>n?0:(s>i&&(i=s),o<n&&(n=o),a=((u>=0?d.z:p.z)-e.z)*u,h=((u>=0?p.z:d.z)-e.z)*u,i>h||a>n?0:(a>i&&(i=a),h<n&&(n=h),n<0?0:i>=0?i:n))}}const At=new _,St=new b,Ot=new b;class _t extends q{constructor(t,{near:e=.1,far:r=100,fov:i=45,aspect:n=1,left:s,right:o,bottom:a,top:h}={}){super(),this.near=e,this.far=r,this.fov=i,this.aspect=n,this.projectionMatrix=new _,this.viewMatrix=new _,this.projectionViewMatrix=new _,this.worldPosition=new b,s||o?this.orthographic({left:s,right:o,bottom:a,top:h}):this.perspective()}perspective({near:t=this.near,far:e=this.far,fov:r=this.fov,aspect:i=this.aspect}={}){return this.projectionMatrix.fromPerspective({fov:r*(Math.PI/180),aspect:i,near:t,far:e}),this.type="perspective",this}orthographic({near:t=this.near,far:e=this.far,left:r=-1,right:i=1,bottom:n=-1,top:s=1}={}){return this.projectionMatrix.fromOrthogonal({left:r,right:i,bottom:n,top:s,near:t,far:e}),this.type="orthographic",this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.inverse(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}lookAt(t){return super.lookAt(t,!0),this}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(At.inverse(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateFrustum(){this.frustum||(this.frustum=[new b,new b,new b,new b,new b,new b]);const t=this.projectionViewMatrix;this.frustum[0].set(t[3]-t[0],t[7]-t[4],t[11]-t[8]).constant=t[15]-t[12],this.frustum[1].set(t[3]+t[0],t[7]+t[4],t[11]+t[8]).constant=t[15]+t[12],this.frustum[2].set(t[3]+t[1],t[7]+t[5],t[11]+t[9]).constant=t[15]+t[13],this.frustum[3].set(t[3]-t[1],t[7]-t[5],t[11]-t[9]).constant=t[15]-t[13],this.frustum[4].set(t[3]-t[2],t[7]-t[6],t[11]-t[10]).constant=t[15]-t[14],this.frustum[5].set(t[3]+t[2],t[7]+t[6],t[11]+t[10]).constant=t[15]+t[14];for(let t=0;t<6;t++){const e=1/this.frustum[t].distance();this.frustum[t].multiply(e),this.frustum[t].constant*=e}}frustumIntersectsMesh(t){if(!t.geometry.attributes.position)return!0;t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere();const e=St;e.copy(t.geometry.bounds.center),e.applyMatrix4(t.worldMatrix);const r=t.geometry.bounds.radius*t.worldMatrix.getMaxScaleOnAxis();return this.frustumIntersectsSphere(e,r)}frustumIntersectsSphere(t,e){const r=Ot;for(let i=0;i<6;i++){const n=this.frustum[i];if(r.copy(n).dot(t)+n.constant<-e)return!1}return!0}}class Ct{constructor(t,{light:e=new _t(t),width:r=1024,height:i=r}){this.gl=t,this.light=e,this.target=new J(t,{width:r,height:i}),this.depthProgram=new G(t,{vertex:Lt,fragment:Pt,cullFace:null}),this.castMeshes=[]}add({mesh:t,receive:e=!0,cast:r=!0,vertex:i=Lt,fragment:n=Pt,uniformProjection:s="shadowProjectionMatrix",uniformView:o="shadowViewMatrix",uniformTexture:a="tShadow"}){e&&!t.program.uniforms[s]&&(t.program.uniforms[s]={value:this.light.projectionMatrix},t.program.uniforms[o]={value:this.light.viewMatrix},t.program.uniforms[a]={value:this.target.texture}),r&&(this.castMeshes.push(t),t.colorProgram=t.program,t.depthProgram||(t.depthProgram=i!==Lt||n!==Pt?new G(gl,{vertex:i,fragment:n,cullFace:null}):this.depthProgram))}render({scene:t}){t.traverse(t=>{t.draw&&(~this.castMeshes.indexOf(t)?t.program=t.depthProgram:(t.visible&&(t.isForceVisibility=!0),t.visible=!1))}),this.gl.renderer.render({scene:t,camera:this.light,target:this.target}),t.traverse(t=>{t.draw&&(~this.castMeshes.indexOf(t)?t.program=t.colorProgram:t.isForceVisibility&&(t.visible=!0))})}}const Lt="\n    attribute vec3 position;\n    attribute vec2 uv;\n\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    void main() {\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n",Pt="\n    precision highp float;\n\n    vec4 packRGBA (float v) {\n        vec4 pack = fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * v);\n        pack -= pack.yzww * vec2(1.0 / 255.0, 0.0).xxxy;\n        return pack;\n    }\n\n    void main() {\n        gl_FragColor = packRGBA(gl_FragCoord.z);\n    }\n";class Tt extends Ct{async add(t,e={}){await t.model,e.mesh=t.body,t.addEventListener("updatemesh",r=>{const i=r.detail.oldMesh;this.castMeshes=this.castMeshes.filter(t=>t!==i),this.add(t,e)}),super.add(e)}}const Rt=ht.Node.Attr,Ft=Symbol.for("spritejs_setAttribute"),Nt=Symbol.for("spritejs_getAttribute"),Dt=Symbol.for("spritejs_setAttributeDefault"),jt=Symbol.for("spritejs_declareAlias");class It extends Rt{constructor(t){super(t),this[Dt]({z:0,rotateX:0,rotateY:0,rotateZ:0,rotateOrder:"YXZ",scaleX:1,scaleY:1,scaleZ:1,raycast:void 0}),this[jt]("rotate","scale")}get z(){return this[Nt]("z")}set z(t){this[Ft]("z",t)}get raycast(){return this[Nt]("raycast")}set raycast(t){this[Ft]("raycast",t)}get pos(){return[this.x,this.y,this.z]}set pos(t){Array.isArray(t)||(t=[t,t,t]),this.x=t[0],this.y=t[1],this.z=t[2]}get rotateX(){return this[Nt]("rotateX")}set rotateX(t){this[Ft]("rotateX",t)}get rotateY(){return this[Nt]("rotateY")}set rotateY(t){this[Ft]("rotateY",t)}get rotateZ(){return this[Nt]("rotateZ")}set rotateZ(t){this[Ft]("rotateZ",t)}get rotate(){return[this.rotateX,this.rotateY,this.rotateZ]}set rotate(t){Array.isArray(t)||(t=[t,0,0]),this.rotateX=t[0],this.rotateY=t[1],this.rotateZ=t[2]}get rotateOrder(){return this[Nt]("rotateOrder")}set rotateOrder(t){this[Ft]("rotateOrder",t)}get scaleX(){return this[Nt]("scaleX")}set scaleX(t){this[Ft]("scaleX",t)}get scaleY(){return this[Nt]("scaleY")}set scaleY(t){this[Ft]("scaleY",t)}get scaleZ(){return this[Nt]("scaleZ")}set scaleZ(t){this[Ft]("scaleZ",t)}get scale(){return[this.scaleX,this.scaleY,this.scaleZ]}set scale(t){Array.isArray(t)||(t=[t,t,t]),this.scaleX=t[0],this.scaleY=t[1],this.scaleZ=t[2]}}const Bt=Symbol("body"),Ut=Symbol.for("spritejs_changedAttrs"),zt=Symbol.for("spritejs_setAttribute");function Gt({attributes:t},{rotation:e}){t[zt]("rotateX",180*e.x/Math.PI),t[zt]("rotateY",180*e.y/Math.PI),t[zt]("rotateZ",180*e.z/Math.PI)}class kt extends ht.Node{get body(){return this[Bt]?this[Bt]:null}get mesh(){return this.body}get meshes(){return[]}get localMatrix(){return this[Bt]?this[Bt].matrix:null}get renderMatrix(){return this.worldMatrix}get worldMatrix(){return this[Bt]?this[Bt].worldMatrix:null}get modelViewMatrix(){return this[Bt]?this[Bt].modelViewMatrix:null}get normalMatrix(){return this[Bt]?this[Bt].normalMatrix:null}get isVisible(){return!!this[Bt]&&this[Bt].visible}get zDepth(){return this[Bt]?this[Bt].zDepth:null}lookAt(t,e=!1){const r=this[Bt];r&&(t instanceof kt&&(t=t.body.position),r.lookAt(t,e),Gt(this,r),this.forceUpdate())}updateMatrix(){this[Bt]&&(this[Bt].updateMatrix(),this.forceUpdate())}updateMatrixWorld(t=!1){this[Bt]&&(this[Bt].updateMatrixWorld(),this.forceUpdate())}traverse(t){this[Bt]&&this[Bt].traverse(e=>{e._node&&t(e._node)})}decompose(){const t=this[Bt];t&&(t.decompose(),Gt(this,t),this.forceUpdate())}setBody(t,e=!0){const r=this[Bt];if(this[Bt]=t,r&&(r.setParent(null),delete r._node),this.parent&&this.parent.body&&this[Bt].setParent(this.parent.body),e){const t=Object.entries(this.attributes[Ut]);for(let e=0;e<t.length;e++){const[r,i]=t[e];this.onPropertyChange(r,i,i)}t.length<=0&&this.forceUpdate()}t._node=this,this.groupBody&&this.children&&this.children.length>0&&this.groupBody.setParent(t)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r);const i=this[Bt];if(i){if("x"!==t&&"y"!==t&&"z"!==t||(i.position[t]=e),"rotateX"===t||"rotateY"===t||"rotateZ"===t){const r=e*Math.PI/180;i.rotation[t.toLowerCase().slice(-1)]=r}"scaleX"!==t&&"scaleY"!==t&&"scaleZ"!==t||(i.scale[t.toLowerCase().slice(-1)]=e),"raycast"===t&&(i.geometry.raycast=e),"display"===t&&(i.visible="none"!==e),"rotateOrder"===t&&i.rotation.reorder(e)}}connect(t,e){if(super.connect(t,e),this[Bt]){const e=t.groupBody||t.body;e&&e!==this[Bt]&&(this[Bt].setParent(e),t.groupBody&&null==t.groupBody.parent&&t.groupBody.setParent(t.body))}}disconnect(t,e){if(super.disconnect(t,e),this[Bt]){this[Bt].setParent(null);const e=t.groupBody;e&&e.children&&e.children.length<=0&&e.setParent(null)}}}var Xt,Yt,Vt;Vt=It,(Yt="Attr")in(Xt=kt)?Object.defineProperty(Xt,Yt,{value:Vt,enumerable:!0,configurable:!0,writable:!0}):Xt[Yt]=Vt,Object(ht.registerNode)(kt,"node3d");const qt=Symbol("zOrder"),Ht=Symbol("children");class Wt extends kt{constructor(t={}){super(t),this.setBody(new q,!1),this[Ht]=[],this[qt]=0}get childNodes(){return this[Ht]}get children(){return this[Ht]}get meshes(){const t=this.children,e=[];for(let r=0;r<t.length;r++){const i=t[r];i.meshes&&i.meshes.length&&e.push(...i.meshes)}return e}append(...t){return t.map(t=>this.appendChild(t))}appendChild(t){return t.remove(),this.children.push(t),t.connect(this,this[qt]++),t}cloneNode(t=!1){const e=super.cloneNode();return t&&this[Ht].forEach(r=>{const i=r.cloneNode(t);e.appendChild(i)}),e}getElementById(t){return ht.Group.prototype.querySelector.call(this,`#${t}`)}getElementsByClassName(t){return ht.Group.prototype.querySelectorAll.call(this,`.${t}`)}getElementsByName(t){return ht.Group.prototype.querySelectorAll.call(this,`[name="${t}"]`)}getElementsByTagName(t){return ht.Group.prototype.querySelectorAll.call(this,t)}insertBefore(t,e){if(null==e)return this.appendChild(t);t.remove();const r=this[Ht].indexOf(e);if(r<0)throw new Error("Invalid reference node.");const i=e.zOrder;for(let t=r;t<this[Ht].length;t++){const e=this[Ht][t].zOrder,r=this[Ht][t];delete r.zOrder,Object.defineProperty(r,"zOrder",{value:e+1,writable:!1,configurable:!0})}return this[Ht].splice(r,0,t),t.connect(this,i),t}querySelector(t){return ht.Group.prototype.querySelector.call(this,t)}querySelectorAll(t){return ht.Group.prototype.querySelectorAll.call(this,t)}replaceChild(t,e){t.remove();const r=this[Ht].indexOf(e);if(r<0)throw new Error("Invalid reference node.");return this[Ht][r]=t,t.connect(this,e.zOrder),e.disconnect(),t}removeAllChildren(){const t=this[Ht];for(let e=t.length-1;e>=0;e--)t[e].remove()}removeChild(t){const e=this[Ht].indexOf(t);return e>=0?(this[Ht].splice(e,1),t.disconnect(),t):null}setResolution({width:t,height:e}){super.setResolution({width:t,height:e}),this[Ht].forEach(r=>{r.setResolution({width:t,height:e})})}}Object(ht.registerNode)(Wt,"group3d");const Zt=Symbol.for("spritejs_setAttribute"),$t=Symbol.for("spritejs_getAttribute"),Qt=Symbol.for("spritejs_setAttributeDefault");function Kt(t,e){if(null==t)return{};var r,i,n=function(t,e){if(null==t)return{};var r,i,n={},s=Object.keys(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||(n[r]=t[r]);return n}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}const Jt=Symbol.for("spritejs_setAttribute");class te extends Wt{constructor(t,e){let{fov:r=45,near:i=.1,far:n=100,aspect:s=1,left:o,right:a,bottom:h,top:l}=e,c=Kt(e,["fov","near","far","aspect","left","right","bottom","top"]);super({fov:r,near:i,far:n,aspect:s,left:o,right:a,bottom:h,top:l}),this.groupBody=this.body,this.setBody(new _t(t,{fov:r,near:i,far:n,aspect:s,left:o,right:a,bottom:h,top:l}),!1),this.attributes[Jt]("mode",this.body.type),c&&this.attr(c)}get projectionMatrix(){return this.body.projectionMatrix}get viewMatrix(){return this.body.viewMatrix}get projectionViewMatrix(){return this.body.projectionViewMatrix}get worldPosition(){return this.body.worldPosition}lookAt(t){return super.lookAt(t,!0),this}project(t){return this.body.project(t),this}unproject(t){return this.body.unproject(t),this}updateFrustum(){return this.body.updateFrustum(),this}frustumIntersects(t){return!!t.body&&this.body.frustumIntersectsMesh(t.body)}frustumIntersectsSphere(t,e){return t instanceof kt&&t.body&&(t=t.body.position),this.body.frustumIntersectsSphere(t,e)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r);const i=this.body;if(i){const r=this.attributes.mode;if("perspective"===r&&("near"===t||"far"===t||"fov"===t||"aspect"===t)){const r="fov"===t?e*(Math.PI/180):e;i.perspective({[t]:r})}if("orthographic"===r&&("left"===t||"right"===t||"bottom"===t||"top"===t)){const{left:t,right:e,bottom:r,top:n}=this.attributes;i.orthographic({left:t,right:e,bottom:r,top:n})}if("mode"===t)if("perspective"===e)i.perspective();else{const{left:t,right:e,bottom:r,top:n}=this.attributes;i.orthographic({left:t,right:e,bottom:r,top:n})}}}}function ee(t,e){if(null==t)return{};var r,i,n=function(t,e){if(null==t)return{};var r,i,n={},s=Object.keys(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||(n[r]=t[r]);return n}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function re(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function ie(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?re(Object(r),!0).forEach((function(e){ne(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):re(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function ne(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}!function(t,e,r){e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(te,"Attr",class extends It{constructor(t){super(t),this[Qt]({near:.1,far:100,fov:45,aspect:1,left:void 0,right:void 0,bottom:void 0,top:void 0,mode:"perspective"})}get near(){return this[$t]("near")}set near(t){this[Zt]("near",t)}get far(){return this[$t]("far")}set far(t){this[Zt]("far",t)}get fov(){return this[$t]("fov")}set fov(t){this[Zt]("fov",t)}get aspect(){return this[$t]("aspect")}set aspect(t){this[Zt]("aspect",t)}get left(){return this[$t]("left")}set left(t){this[Zt]("left",t)}get right(){return this[$t]("right")}set right(t){this[Zt]("right",t)}get top(){return this[$t]("top")}set top(t){this[Zt]("top",t)}get bottom(){return this[$t]("bottom")}set bottom(t){this[Zt]("bottom",t)}get mode(){return this[$t]("mode")}set mode(t){if(t&&"perspective"!==t&&"orthographic"!==t)throw new TypeError("Invalid camera mode.");this[Zt]("mode",t)}}),Object(ht.registerNode)(te,"camera");const se={depth:!0,alpha:!0},oe=Symbol("orbit_controls"),ae=Symbol("orbit_checker"),he=Symbol("orbit_checking"),le=Symbol("utime"),ce=Symbol("shadow"),ue=Symbol("directionalLight"),de=Symbol("pointLightPosition"),pe=Symbol("pointLightColor"),ge=Symbol("ambientColor"),me=Symbol("targets"),fe=Symbol("post"),ve=Symbol("renderOptions");class be extends ht.Layer{constructor(t={}){if("2d"===t.contextType)throw new TypeError("Cannot create 3d layer in 2d context.");t.Renderer||((t=Object.assign({},se,t)).Renderer=function(t,e){e=Object.assign({},e);const r=new ct(ie({canvas:t},e));return r.globalTransformMatrix=[1,0,0,1,0,0],r.setGlobalTransform=function(t){},r}),super(t),this[le]=[],this[me]=[],this[ue]=t.directionalLight||[1,0,0,0],this[de]=t.pointLightPosition||[0,0,0],this[pe]=new ht.Color(t.pointLightColor||[0,0,0,0]),this[ge]=new ht.Color(t.ambientColor||[1,1,1,0]),this[ve]={update:!0,sort:!0,frustumCull:!0,clear:void 0};const e=this.renderer.gl;e.clearColor(...this[ge]),t.post&&("boolean"==typeof t.post&&(t.post={}),this[fe]=new ut(e,t.post)),t.camera=t.camera||{};const r=new te(e,t.camera);r.connect(this,0),this.camera=r,this.root=new Wt,this.root.connect(this,0)}get body(){return this.root?this.root.body:null}get gl(){return this.renderer.gl}get post(){return this[fe]}get meshes(){const t=this.children,e=[];for(let r=0;r<t.length;r++){const i=t[r];i.meshes&&i.meshes.length&&e.push(...i.meshes)}return e}get autoClear(){return this.renderer.autoClear}set autoClear(t){this.renderer.autoClear=t}setResolution({width:t,height:e}){super.setResolution({width:t,height:e});const r=this.displayRatio,i=this.renderer;this.renderer.dpr=r,i.width=t/r,i.height=e/r;const n=i.gl;n.canvas.width=t,n.canvas.height=e;const s=this.camera;s&&!1!==this.options.camera.preserveAspect&&(s.attributes.aspect=t/e),this[fe]&&this[fe].resize()}setUniforms(t,e){super.setUniforms(e),Object.entries(e).forEach(([e,r])=>{t.uniforms[e]={value:r}}),this.forceUpdate()}setLights(t,{directionalLight:e=this[ue],pointLightPosition:r=this[de],pointLightColor:i=this[pe],ambientColor:n=this[ge]}={}){t.uniforms.directionalLight.value=e,t.uniforms.pointLightPosition.value=r,t.uniforms.pointLightColor.value=new ht.Color(i),t.uniforms.ambientColor.value=new ht.Color(n),this.forceUpdate()}traverse(t){return this.root.traverse(t)}createProgram(t={},{attributes:e,uniforms:r}={}){let{attributes:i,texture:n,uniforms:s}=t,o=ee(t,["attributes","texture","uniforms"]);const a=this.renderer.gl;s&&(o.uniforms=ie({},s));const h=new G(a,o);return e&&(h.extraAttribute=Object.assign({},i,e)),h.uniforms.directionalLight={value:this[ue]},h.uniforms.pointLightPosition={value:this[de]},h.uniforms.pointLightColor={value:this[pe]},h.uniforms.ambientColor={value:this[ge]},n&&(h.uniforms.tMap={value:n}),r&&Object.assign(h.uniforms,r),h}get orbitControls(){return this[oe]}setOrbit(t={}){this[ae]||(this[ae]=[()=>{this[he]=!0},()=>{this[he]=!1},()=>{this[he]&&this.forceUpdate()},()=>{this.forceUpdate()}]);const e=this.camera;if(this[oe]&&(this[oe].remove(),this.removeEventListener("mousedown",this[ae][0]),this.removeEventListener("mouseup",this[ae][1]),this.removeEventListener("mousemove",this[ae][2]),this.removeEventListener("touchstart",this[ae][3]),this.removeEventListener("touchend",this[ae][3]),this.removeEventListener("touchmove",this[ae][3]),this.removeEventListener("wheel",this[ae][3],!1)),null==t)return delete this[oe],null;const r=t.target||[0,0,0];return t.target=new b(...r),t.element=t.element||this.parent.container,this[oe]=new bt(e.body,t),this.addEventListener("mousedown",this[ae][0]),this.addEventListener("mouseup",this[ae][1]),this.addEventListener("mousemove",this[ae][2]),this.addEventListener("touchstart",this[ae][3]),this.addEventListener("touchend",this[ae][3]),this.addEventListener("touchmove",this[ae][3]),this.addEventListener("wheel",this[ae][3],!1),this[oe]}setRaycast(t=!0){if(t){const t=this.renderer.gl;this.raycast=new Mt(t)}else delete this.raycast}bindTime(t,e={}){t.timeline=this.timeline.fork(e),this[le].push(t),this.forceUpdate()}unbindTime(t){const e=this[le].indexOf(t);return e>=0&&(this[le].splice(e,1),!0)}createText(t,{font:e,fillColor:r="#000",strokeColor:i,strokeWidth:n=1}){const s=ht.ENV.createText(t,{font:e,fillColor:r,strokeColor:i,strokeWidth:n}).image;return this.createTexture({image:s,generateMipmaps:!1,width:s.width,height:s.height})}async loadImage(t){return await ht.ENV.loadImage(t)}async loadImages(t){return await Promise.all(t.map(t=>ht.ENV.loadImage(t,{useImageBitmap:!1})))}async loadShader({vertex:t,fragment:e}){const r=await Promise.all([(await fetch(t)).text(),(await fetch(e)).text()]);return{vertex:r[0],fragment:r[1]}}async loadModel(t){return await(await fetch(t)).json()}createTexture(t){const e=this.renderer.gl;let r;function i(t){return"string"==typeof t||Array.isArray(t)&&"string"==typeof t[0]}i(t)?(r=t,t={}):i(t.image)?(r=t.image,delete(t=ie({},t)).image):Array.isArray(t)&&(t={image:t});const n=new K(e,t);if(r){let t;return t=Array.isArray(r)?this.loadImages(r):this.loadImage(r),t.then(t=>{n.image=t,this.forceUpdate()}),n}return n}createShadow({width:t=this.canvas.width,height:e=this.canvas.height,light:r=this.camera}={}){const i=this.renderer.gl;return new Tt(i,{width:t,height:e,light:r.body})}setShadow(t){this[ce]=t,this.forceUpdate()}get shadow(){return this[ce]}dispatchPointerEvent(t){const e=this.raycast;if(e){const r=new h,i=this.renderer;r.set(t.x/i.width*2-1,2*(1-t.y/i.height)-1),e.castMouse(this.camera.body,r);const n=e.intersectBounds(this.meshes);if(n&&n.length){const e=n[0];return t.target=e._node,t.mouse=r,e._node.dispatchEvent(t),!0}}return ht.Block.prototype.dispatchPointerEvent.call(this,t)}bindTarget(t,e={}){this[me].push({target:t,options:e})}unbindTarget(t){const e=this[me].indexOf(t);return e>=0&&(this[me].splice(e,1),!0)}renderTarget(t,e={}){return t.renderBy(this,e)}setRenderOptions(t){Object.assign(this[ve],t)}get renderOptions(){return this[ve]}render(){const{camera:t,root:e}=this;this.dispatchEvent({type:"beforerender",detail:{camera:t.body}}),this[me].length&&this[me].forEach(({target:t,options:e})=>{t.renderBy(this,e)}),this[oe]&&this[oe].update(),this[ce]&&this[ce].render({scene:e.body}),this[fe]?(this.postRender&&this.postRender(),this[fe].render(ie({scene:e.body,camera:t.body},this[ve]))):this.renderer.render(ie({scene:e.body,camera:t.body},this[ve])),this._prepareRenderFinished(),this[le].length&&(this[le].forEach(t=>{t.uniforms.uTime.value=.001*t.timeline.currentTime}),this.forceUpdate()),this.dispatchEvent({type:"afterrender",detail:{camera:t.body}})}}function ye(t,e){if(null==t)return{};var r,i,n=function(t,e){if(null==t)return{};var r,i,n={},s=Object.keys(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||(n[r]=t[r]);return n}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function we(t,e=3){let r=t.data||t;Array.isArray(r)&&(r=new Float32Array(r));const i=t.size||e;return t.data?(t.data=r,t.size=i,t):{size:i,data:r}}Object(ht.registerNode)(be,"layer3d");class xe extends it{constructor(t,e){const{position:r,uv:i,normal:n,index:s}=e,o=ye(e,["position","uv","normal","index"]),a={};if(r&&(a.position=we(r)),i&&(a.uv=we(i,2)),n&&(a.normal=we(n)),s){let t=s.data||s;Array.isArray(t)&&(t=new Uint16Array(t)),a.index={data:t}}if(o){let t;const e=a.position;e&&(t=e.data.length/e.size),Object.entries(o).forEach(([e,r])=>{let i=3;if(!r.size){const e=r.data?r.data.length:r.length;e&&t&&(i=e/t)}a[e]=we(r,i)})}super(t,a)}}const Ee=Symbol.for("spritejs_setAttribute"),Me=Symbol.for("spritejs_getAttribute"),Ae=Symbol.for("spritejs_setAttributeDefault");class Se extends It{constructor(t){super(t),this[Ae]({mode:"TRIANGLES",colors:[.5,.5,.5,1],colorDivisor:3})}get colors(){return this[Me]("colors")}set colors(t){if("string"==typeof t){let e=(t=t.replace(/\s*,\s*/g,",")).split(/\s+/g);e=e.map(t=>new ht.Color(t)),t=e.reduce((t,e)=>[...t,...e])}else Array.isArray(t)&&("string"==typeof t[0]?t=t.reduce((t,e)=>(t.push(...new ht.Color(e)),t),[]):Array.isArray(t[0])&&(t=t.reduce((t,e)=>[...t,...e])));this[Ee]("colors",t)}get colorDivisor(){return this[Me]("colorDivisor")}set colorDivisor(t){this[Ee]("colorDivisor",t)}get mode(){return this[Me]("mode")}set mode(t){if("number"==typeof t&&t>=0&&t<5&&(t=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES"][t]),t&&"TRIANGLES"!==t&&"POINTS"!==t&&"LINES"!==t&&"LINE_LOOP"!==t&&"LINE_STRIP"!==t)throw new TypeError("Invalid mode value.");this[Ee]("mode",t)}}function Oe(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function _e(t,e){if(null==t)return{};var r,i,n=function(t,e){if(null==t)return{};var r,i,n={},s=Object.keys(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||(n[r]=t[r]);return n}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}function Ce(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}const Le=Symbol.for("spritejs_changedAttrs"),Pe=Symbol("program"),Te=Symbol("geometry"),Re=Symbol("model"),Fe=Symbol("beforeRender"),Ne=Symbol("afterRender");function De(t,e){const r=e.attributes.color,i=e.attributes.position.data.length/3,n=r?r.data:new Float32Array(4*i),s=t.attributes.colors,o=s.length/4,a=t.attributes.colorDivisor;for(let t=0;t<i;t++){const e=Math.floor(t/a)%o;n[4*t]=s[4*e],n[4*t+1]=s[4*e+1],n[4*t+2]=s[4*e+2],n[4*t+3]=s[4*e+3]}return r&&(r.needsUpdate=!0),{size:4,data:n}}function je(t,e,r){const i=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],n=[e[0]-r[0],e[1]-r[1],e[2]-r[2]];return function(t){const e=Math.hypot(...t);return[t[0]/e,t[1]/e,t[2]/e]}([i[1]*n[2]-i[2]*n[1],i[0]*n[2]-i[2]*n[0],i[0]*n[1]-i[1]*n[0]])}class Ie extends Wt{constructor(t,e={}){let{model:r}=e,i=_e(e,["model"]);if(!t||t instanceof G||(i=t,t=i.program),!t)throw new Error("No program specified!");super(i),this.groupBody=this.body,this.setProgram(t),this[Fe]=t=>{this.dispatchEvent({type:"beforerender",detail:t})},this[Ne]=t=>{this.dispatchEvent({type:"afterrender",detail:t})},r&&"function"==typeof r.then?this[Re]=r.then(t=>{this[Re]=t,this.remesh()}):r?this.setGeometry(r):this.remesh()}cloneNode(t=!1){const e=this.attributes[Le],r=new this.constructor(this[Pe],function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Oe(Object(r),!0).forEach((function(e){Ce(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Oe(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({},e,{model:this[Te]}));return t&&this.children.forEach(e=>{const i=e.cloneNode(t);r.appendChild(i)}),r}get model(){return this[Re]}get program(){return this[Pe]}get geometry(){return this[Te]}get meshes(){const t=super.meshes;return this.body.geometry&&t.unshift(this.body),t}setProgram(t){this[Pe]=t;const e=t.gl;t.extraAttribute=t.extraAttribute||{},t.attributeLocations.has("color")&&!t.extraAttribute.color&&(t.extraAttribute.color=De);const r=this[Te];if(r){const i=this.attributes.mode,n=new W(t.gl,{mode:e[i],geometry:r,program:t});this.setBody(n)}}setGeometry(t=this[Re]){if(!t)return;const e=this[Pe],r=e.gl;let i;if(i=t instanceof it?t:new xe(r,t),!i.attributes.normal&&e.attributeLocations.has("normal")){const t=i.attributes.position.data,e=i.attributes.position.data.length,r=new Float32Array(e);if(e%9==0)for(let i=0;i<e;i+=9){const e=je([t[i],t[i+1],t[i+2]],[t[i+3],t[i+4],t[i+5]],[t[i+6],t[i+7],t[i+8]]);r.set([...e,...e,...e],i)}else if(e%3==0)for(let t=0;t<e;t+=3)r.set([-1,0,0],t);i.addAttribute("normal",{size:3,data:r})}const n=e.extraAttribute;n&&Object.entries(n).forEach(([t,e])=>{i.attributes[t]||i.addAttribute(t,e(this,i))}),this[Te]=i,this[Re]=i.attributes;const s=this.attributes.mode,o=new W(r,{mode:r[s],geometry:i,program:e});this.setBody(o);let a=this.getListeners("beforerender");a.length&&o.onBeforeRender(this[Fe]),a=this.getListeners("afterrender"),a.length&&o.onAfterRender(this[Ne])}addEventListener(t,e,r={}){if(super.addEventListener(t,e,r),this.body.onBeforeRender&&"beforerender"===t){1===this.getListeners("beforerender").length&&this.body.onBeforeRender(this[Fe])}else if(this.body.onAfterRender&&"afterrender"===t){1===this.getListeners("afterrender").length&&this.body.onAfterRender(this[Ne])}return this}removeAllListeners(t,e={}){if(super.removeAllListeners(t,e),this.body.onBeforeRender&&"beforerender"===t){const t=this.body.beforeRenderCallbacks.indexOf(this[Fe]);t>=0&&this.body.beforeRenderCallbacks.splice(t,1)}else if(this.body.onAfterRender&&"afterrender"===t){const t=this.body.afterRenderCallbacks.indexOf(this[Ne]);t>=0&&this.body.afterRenderCallbacks.splice(t,1)}return this}removeEventListener(t,e,r={}){if(super.removeEventListener(t,e,r),this.body.onBeforeRender&&"beforerender"===t){if(0===this.getListeners("beforerender").length){const t=this.body.beforeRenderCallbacks.indexOf(this[Fe]);t>=0&&this.body.beforeRenderCallbacks.splice(t,1)}}else if(this.body.onAfterRender&&"afterrender"===t){if(0===this.getListeners("afterrender").length){const t=this.body.afterRenderCallbacks.indexOf(this[Ne]);t>=0&&this.body.afterRenderCallbacks.splice(t,1)}}return this}remesh(){this.setGeometry()}updateMesh(){if(this.program){const t=this.mesh;this.remesh();const e=this.mesh;this.dispatchEvent({type:"updatemesh",detail:{oldMesh:t,newMesh:e}})}}onPropertyChange(t,e,r){if(super.onPropertyChange(t,e,r),("colors"===t||"colorDivisor"===t)&&e!==r){const t=this.program;if(t&&t.extraAttribute.color){De(this,this.geometry)}}if("mode"===t){const t=this.program;t&&(this.body.mode=t.gl[e])}}}Ce(Ie,"Attr",Se),Object(ht.registerNode)(Ie,"mesh3d");class Be extends it{constructor(t,{radius:e=.5,widthSegments:r=16,heightSegments:i=Math.ceil(.5*r),phiStart:n=0,phiLength:s=2*Math.PI,thetaStart:o=0,thetaLength:a=Math.PI,attributes:h={}}={}){const l=r,c=i,u=n,d=s,p=o,g=a,m=(l+1)*(c+1),f=l*c*6,v=new Float32Array(3*m),y=new Float32Array(3*m),w=new Float32Array(2*m),x=m>65536?new Uint32Array(f):new Uint16Array(f);let E=0,M=0,A=0,S=p+g;const O=[];let _=new b;for(let t=0;t<=c;t++){let r=[],i=t/c;for(let t=0;t<=l;t++,E++){let n=t/l,s=-e*Math.cos(u+n*d)*Math.sin(p+i*g),o=e*Math.cos(p+i*g),a=e*Math.sin(u+n*d)*Math.sin(p+i*g);v[3*E]=s,v[3*E+1]=o,v[3*E+2]=a,_.set(s,o,a).normalize(),y[3*E]=_.x,y[3*E+1]=_.y,y[3*E+2]=_.z,w[2*E]=n,w[2*E+1]=1-i,r.push(M++)}O.push(r)}for(let t=0;t<c;t++)for(let e=0;e<l;e++){let r=O[t][e+1],i=O[t][e],n=O[t+1][e],s=O[t+1][e+1];(0!==t||p>0)&&(x[3*A]=r,x[3*A+1]=i,x[3*A+2]=s,A++),(t!==c-1||S<Math.PI)&&(x[3*A]=i,x[3*A+1]=n,x[3*A+2]=s,A++)}Object.assign(h,{position:{size:3,data:v},normal:{size:3,data:y},uv:{size:2,data:w},index:{data:x}}),super(t,h)}}const Ue=Symbol.for("spritejs_setAttribute"),ze=Symbol.for("spritejs_getAttribute"),Ge=Symbol.for("spritejs_setAttributeDefault");class ke extends Ie{remesh(){const t=this.program.gl,{radius:e,widthSegments:r,heightSegments:i,phiStart:n,phiLength:s,thetaStart:o,thetaLength:a}=this.attributes,h=new Be(t,{radius:e,widthSegments:r,heightSegments:i,phiStart:n,phiLength:s,thetaStart:o,thetaLength:a});this.setGeometry(h)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r),"radius"!==t&&"widthSegments"!==t&&"heightSegments"!==t&&"phiStart"!==t&&"phiLength"!==t&&"thetaStart"!==t&&"thetaLength"!==t||e!==r&&this.updateMesh()}}!function(t,e,r){e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(ke,"Attr",class extends Se{constructor(t){super(t),this[Ge]({radius:.5,widthSegments:32,heightSegments:16,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI})}get radius(){return this[ze]("radius")}set radius(t){this[Ue]("radius",t)}get widthSegments(){return this[ze]("widthSegments")}set widthSegments(t){this[Ue]("widthSegments",t)}get heightSegments(){return this[ze]("heightSegments")}set heightSegments(t){this[Ue]("heightSegments",t)}get phiStart(){return this[ze]("phiStart")}set phiStart(t){this[Ue]("phiStart",t)}get phiLength(){return this[ze]("phiLength")}set phiLength(t){this[Ue]("phiLength",t)}get thetaStart(){return this[ze]("thetaStart")}set thetaStart(t){this[Ue]("thetaStart",t)}get thetaLength(){return this[ze]("thetaLength")}set thetaLength(t){this[Ue]("thetaLength",t)}}),Object(ht.registerNode)(ke,"sphere");class Xe extends it{constructor(t,{width:e=1,height:r=1,widthSegments:i=1,heightSegments:n=1,attributes:s={}}={}){const o=i,a=n,h=(o+1)*(a+1),l=o*a*6,c=new Float32Array(3*h),u=new Float32Array(3*h),d=new Float32Array(2*h),p=h>65536?new Uint32Array(l):new Uint16Array(l);Xe.buildPlane(c,u,d,p,e,r,0,o,a),Object.assign(s,{position:{size:3,data:c},normal:{size:3,data:u},uv:{size:2,data:d},index:{data:p}}),super(t,s)}static buildPlane(t,e,r,i,n,s,o,a,h,l=0,c=1,u=2,d=1,p=-1,g=0,m=0){const f=g,v=n/a,b=s/h;for(let y=0;y<=h;y++){let w=y*b-s/2;for(let s=0;s<=a;s++,g++){let b=s*v-n/2;if(t[3*g+l]=b*d,t[3*g+c]=w*p,t[3*g+u]=o/2,e[3*g+l]=0,e[3*g+c]=0,e[3*g+u]=o>=0?1:-1,r[2*g]=s/a,r[2*g+1]=1-y/h,y===h||s===a)continue;let x=f+s+y*(a+1),E=f+s+(y+1)*(a+1),M=f+s+(y+1)*(a+1)+1,A=f+s+y*(a+1)+1;i[6*m]=x,i[6*m+1]=E,i[6*m+2]=A,i[6*m+3]=E,i[6*m+4]=M,i[6*m+5]=A,m++}}}}class Ye extends it{constructor(t,{width:e=1,height:r=1,depth:i=1,widthSegments:n=1,heightSegments:s=1,depthSegments:o=1,attributes:a={}}={}){const h=n,l=s,c=o,u=(h+1)*(l+1)*2+(h+1)*(c+1)*2+(l+1)*(c+1)*2,d=6*(h*l*2+h*c*2+l*c*2),p=new Float32Array(3*u),g=new Float32Array(3*u),m=new Float32Array(2*u),f=u>65536?new Uint32Array(d):new Uint16Array(d);let v=0,b=0;Xe.buildPlane(p,g,m,f,i,r,e,c,l,2,1,0,-1,-1,v,b),Xe.buildPlane(p,g,m,f,i,r,-e,c,l,2,1,0,1,-1,v+=(c+1)*(l+1),b+=c*l),Xe.buildPlane(p,g,m,f,e,i,r,c,l,0,2,1,1,1,v+=(c+1)*(l+1),b+=c*l),Xe.buildPlane(p,g,m,f,e,i,-r,c,l,0,2,1,1,-1,v+=(h+1)*(c+1),b+=h*c),Xe.buildPlane(p,g,m,f,e,r,-i,h,l,0,1,2,-1,-1,v+=(h+1)*(c+1),b+=h*c),Xe.buildPlane(p,g,m,f,e,r,i,h,l,0,1,2,1,-1,v+=(h+1)*(l+1),b+=h*l),Object.assign(a,{position:{size:3,data:p},normal:{size:3,data:g},uv:{size:2,data:m},index:{data:f}}),super(t,a)}}const Ve=Symbol.for("spritejs_setAttribute"),qe=Symbol.for("spritejs_getAttribute"),He=Symbol.for("spritejs_setAttributeDefault");class We extends Ie{remesh(){const t=this.program.gl,{width:e,height:r,depth:i,widthSegments:n,heightSegments:s,depthSegments:o}=this.attributes,a=new Ye(t,{width:e,height:r,depth:i,widthSegments:n,heightSegments:s,depthSegments:o});this.setGeometry(a)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r),"width"!==t&&"height"!==t&&"depth"!==t&&"widthSegments"!==t&&"heightSegments"!==t&&"depthSegments"!==t||e!==r&&this.updateMesh()}}!function(t,e,r){e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(We,"Attr",class extends Se{constructor(t){super(t),this[He]({width:1,height:1,depth:1,widthSegments:1,heightSegments:1,depthSegments:1,colorDivisor:4})}get width(){return this[qe]("width")}set width(t){this[Ve]("width",t)}get height(){return this[qe]("height")}set height(t){this[Ve]("height",t)}get depth(){return this[qe]("depth")}set depth(t){this[Ve]("depth",t)}get widthSegments(){return this[qe]("widthSegments")}set widthSegments(t){this[Ve]("widthSegments",t)}get heightSegments(){return this[qe]("heightSegments")}set heightSegments(t){this[Ve]("heightSegments",t)}get depthSegments(){return this[qe]("depthSegments")}set depthSegments(t){this[Ve]("depthSegments",t)}}),Object(ht.registerNode)(We,"cube");const Ze=Symbol.for("spritejs_setAttribute"),$e=Symbol.for("spritejs_getAttribute"),Qe=Symbol.for("spritejs_setAttributeDefault");class Ke extends Ie{remesh(){const t=this.program.gl,{width:e,height:r,widthSegments:i,heightSegments:n}=this.attributes,s=new Xe(t,{width:e,height:r,widthSegments:i,heightSegments:n});this.setGeometry(s)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r),"width"!==t&&"height"!==t&&"widthSegments"!==t&&"heightSegments"!==t||e!==r&&this.updateMesh()}}!function(t,e,r){e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(Ke,"Attr",class extends Se{constructor(t){super(t),this[Qe]({width:1,height:1,widthSegments:1,heightSegments:1})}get width(){return this[$e]("width")}set width(t){this[Ze]("width",t)}get height(){return this[$e]("height")}set height(t){this[Ze]("height",t)}get widthSegments(){return this[$e]("widthSegments")}set widthSegments(t){this[Ze]("widthSegments",t)}get heightSegments(){return this[$e]("heightSegments")}set heightSegments(t){this[Ze]("heightSegments",t)}}),Object(ht.registerNode)(Ke,"plane");class Je extends it{constructor(t,{radiusTop:e=.5,radiusBottom:r=.5,height:i=1,radialSegments:n=8,heightSegments:s=1,openEnded:o=!1,thetaStart:a=0,thetaLength:h=2*Math.PI,attributes:l={}}={}){const c=n,u=s,d=a,p=h,g=o?0:r&&e?2:1,m=(c+1)*(u+1+g)+g,f=c*u*6+g*c*3,v=new Float32Array(3*m),y=new Float32Array(3*m),w=new Float32Array(2*m),x=m>65536?new Uint32Array(f):new Uint16Array(f);let E=0,M=0;const A=[];function S(t){let n;const s=!0===t?e:r,o=!0===t?1:-1,a=E;for(v.set([0,.5*i*o,0],3*E),y.set([0,o,0],3*E),w.set([.5,.5],2*E),E++,n=0;n<=c;n++){const t=n/c*p+d,e=Math.cos(t),r=Math.sin(t);v.set([s*r,.5*i*o,s*e],3*E),y.set([0,o,0],3*E),w.set([.5*e+.5,.5*r*o+.5],2*E),E++}for(n=0;n<c;n++){const e=a+n+1;t?x.set([e,e+1,a],3*M):x.set([e+1,e,a],3*M),M++}}!function(){let t,n;const s=new b,o=(r-e)/i;for(n=0;n<=u;n++){const a=[],h=n/u,l=h*(r-e)+e;for(t=0;t<=c;t++){const e=t/c,r=e*p+d,n=Math.sin(r),u=Math.cos(r);v.set([l*n,(.5-h)*i,l*u],3*E),s.set(n,o,u).normalize(),y.set([s.x,s.y,s.z],3*E),w.set([e,1-h],2*E),a.push(E++)}A.push(a)}for(t=0;t<c;t++)for(n=0;n<u;n++){const e=A[n][t],r=A[n+1][t],i=A[n+1][t+1],s=A[n][t+1];x.set([e,r,s,r,i,s],3*M),M+=2}}(),o||(e&&S(!0),r&&S(!1)),Object.assign(l,{position:{size:3,data:v},normal:{size:3,data:y},uv:{size:2,data:w},index:{data:x}}),super(t,l)}}const tr=Symbol.for("spritejs_setAttribute"),er=Symbol.for("spritejs_getAttribute"),rr=Symbol.for("spritejs_setAttributeDefault");class ir extends Ie{remesh(){const t=this.program.gl,{radiusTop:e,radiusBottom:r,height:i,radialSegments:n,heightSegments:s,openEnded:o,thetaStart:a,thetaLength:h}=this.attributes,l=new Je(t,{radiusTop:e,radiusBottom:r,height:i,radialSegments:n,heightSegments:s,openEnded:o,thetaStart:a,thetaLength:h});this.setGeometry(l)}onPropertyChange(t,e,r){super.onPropertyChange(t,e,r),"radiusTop"!==t&&"radiusBottom"!==t&&"height"!==t&&"radialSegments"!==t&&"heightSegments"!==t&&"openEnded"!==t&&"thetaStart"!==t&&"thetaLength"!==t||e!==r&&this.updateMesh()}}function nr(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function sr(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function or(t,e){if(null==t)return{};var r,i,n=function(t,e){if(null==t)return{};var r,i,n={},s=Object.keys(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||(n[r]=t[r]);return n}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(i=0;i<s.length;i++)r=s[i],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}!function(t,e,r){e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(ir,"Attr",class extends Se{constructor(t){super(t),this[rr]({radiusTop:.5,radiusBottom:.5,height:1,radialSegments:16,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:2*Math.PI})}get radiusTop(){return this[er]("radiusTop")}set radiusTop(t){this[tr]("radiusTop",t)}get radiusBottom(){return this[er]("radiusBottom")}set radiusBottom(t){this[tr]("radiusBottom",t)}get height(){return this[er]("height")}set height(t){this[tr]("height",t)}get radialSegments(){return this[er]("radialSegments")}set radialSegments(t){this[tr]("radialSegments",t)}get heightSegments(){return this[er]("heightSegments")}set heightSegments(t){this[tr]("heightSegments",t)}get openEnded(){return this[er]("openEnded")}set openEnded(t){this[tr]("openEnded",t)}get thetaStart(){return this[er]("thetaStart")}set thetaStart(t){this[tr]("thetaStart",t)}get thetaLength(){return this[er]("thetaLength")}set thetaLength(t){this[tr]("thetaLength",t)}}),Object(ht.registerNode)(ir,"cylinder");class ar extends Wt{constructor(t,e={}){let{width:r=t.canvas.width,height:i=t.canvas.height,target:n=t.FRAMEBUFFER,color:s=1,depth:o=!0,stencil:a=!1,depthTexture:h=!1,wrapS:l=t.CLAMP_TO_EDGE,wrapT:c=t.CLAMP_TO_EDGE,minFilter:u=t.LINEAR,magFilter:d=u,type:p=t.UNSIGNED_BYTE,format:g=t.RGBA,internalFormat:m=g,unpackAlignment:f,premultiplyAlpha:v,camera:b,buffer:y=!1}=e;super(or(e,["width","height","target","color","depth","stencil","depthTexture","wrapS","wrapT","minFilter","magFilter","type","format","internalFormat","unpackAlignment","premultiplyAlpha","camera","buffer"]));const w={width:r,height:i,target:n,color:s,depth:o,stencil:a,depthTexture:h,wrapS:l,wrapT:c,minFilter:u,magFilter:d,type:p,format:g,internalFormat:m,unpackAlignment:f,premultiplyAlpha:v};if(this.options=w,this.target=new J(t,w),y&&(this.buffer=new J(t,this.options)),b){const e=new te(t,b);e.connect(this,0),this.camera=e}}swap(){if(null==this.buffer)throw new Error("No buffer to swap. You must set buffer option to true when creating the renderTarget object.");[this.target,this.buffer]=[this.buffer,this.target]}get texture(){return this.buffer?this.buffer.texture:this.target.texture}renderBy(t,e={}){let{root:r=this}=e,i=or(e,["root"]);const n=this.camera?this.camera.body:null,s=this.target;return this.dispatchEvent({type:"beforerender",detail:{scene:r,camera:n,renderer:t}}),t.renderer.render(function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?nr(Object(r),!0).forEach((function(e){sr(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):nr(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({scene:r.body,camera:n,target:s},i)),this.dispatchEvent({type:"afterrender",detail:{scene:r,camera:n,renderer:t}}),this.target.texture}}Object(ht.registerNode)(ar,"rendertarget");class hr extends K{constructor(t,{buffer:e,wrapS:r=t.CLAMP_TO_EDGE,wrapT:i=t.CLAMP_TO_EDGE,anisotropy:n=0}={}){if(super(t,{generateMipmaps:!1,wrapS:r,wrapT:i,anisotropy:n}),e)return this.parseBuffer(e)}parseBuffer(t){const e=new lr(t);e.mipmaps.isCompressedTexture=!0,this.image=e.mipmaps,this.internalFormat=e.glInternalFormat,this.minFilter=e.numberOfMipmapLevels>1?this.gl.NEAREST_MIPMAP_LINEAR:this.gl.LINEAR}}function lr(t){const e=[171,75,84,88,32,49,49,187,13,10,26,10],r=new Uint8Array(t,0,12);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return console.error("File missing KTX identifier");const i=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(t,12,13*i),s=67305985===n.getUint32(0,!0);if(0!==n.getUint32(1*i,s))return console.warn("only compressed formats currently supported");this.glInternalFormat=n.getUint32(4*i,s);let o=n.getUint32(6*i,s),a=n.getUint32(7*i,s);this.numberOfFaces=n.getUint32(10*i,s),this.numberOfMipmapLevels=Math.max(1,n.getUint32(11*i,s));const h=n.getUint32(12*i,s);this.mipmaps=[];let l=64+h;for(let e=0;e<this.numberOfMipmapLevels;e++){const e=new Int32Array(t,l,1)[0];l+=4;for(let r=0;r<this.numberOfFaces;r++){const r=new Uint8Array(t,l,e);this.mipmaps.push({data:r,width:o,height:a}),l+=e,l+=3-(e+3)%4}o>>=1,a>>=1}}const cr=[];class ur{static load(t,{src:e,wrapS:r=t.CLAMP_TO_EDGE,wrapT:i=t.CLAMP_TO_EDGE,anisotropy:n=0,format:s=t.RGBA,internalFormat:o=s,generateMipmaps:a=!0,minFilter:h=(a?t.NEAREST_MIPMAP_LINEAR:t.LINEAR),magFilter:l=t.LINEAR,premultiplyAlpha:c=!1,unpackAlignment:u=4,flipY:d=!0}={}){const p=this.getSupportedExtensions(t);let g,m="none";if("string"==typeof e&&(m=e.split(".").pop().split("?")[0].toLowerCase()),"object"==typeof e)for(const t in e)if(p.includes(t.toLowerCase())){m=t.toLowerCase(),e=e[t];break}switch(m){case"ktx":case"pvrtc":case"s3tc":case"etc":case"etc1":case"astc":g=new hr(t,{src:e,wrapS:r,wrapT:i,anisotropy:n}),g.loaded=this.loadKTX(e,g);break;case"webp":case"jpg":case"jpeg":case"png":g=new K(t,{wrapS:r,wrapT:i,anisotropy:n,format:s,internalFormat:o,generateMipmaps:a,minFilter:h,magFilter:l,premultiplyAlpha:c,unpackAlignment:u,flipY:d}),g=loaded=this.loadImage(t,e,g);break;default:console.warn("No supported format supplied"),g=new K(t)}return g.format=m,g}static getSupportedExtensions(t){if(cr.length)return cr;const e={pvrtc:t.renderer.getExtension("WEBGL_compressed_texture_pvrtc"),s3tc:t.renderer.getExtension("WEBGL_compressed_texture_s3tc"),etc:t.renderer.getExtension("WEBGL_compressed_texture_etc"),etc1:t.renderer.getExtension("WEBGL_compressed_texture_etc1"),astc:t.renderer.getExtension("WEBGL_compressed_texture_astc")};for(const t in e)e[t]&&cr.push(t);return dr&&cr.push("webp"),cr.push("png","jpg"),cr}static loadKTX(t,e){return fetch(t).then(t=>t.arrayBuffer()).then(t=>e.parseBuffer(t))}static loadImage(t,e,r){return function(t){return new Promise(e=>{const r=new Image;r.src=t;const i=navigator.userAgent.toLowerCase().includes("chrome");window.createImageBitmap&&i?r.onload=()=>{createImageBitmap(r,{imageOrientation:"flipY",premultiplyAlpha:"none"}).then(t=>{e(t)})}:r.onload=()=>e(r)})}(e).then(e=>{pr(e.width)&&pr(e.height)||(r.generateMipmaps&&(r.generateMipmaps=!1),r.minFilter===t.NEAREST_MIPMAP_LINEAR&&(r.minFilter=t.LINEAR),r.wrapS===t.REPEAT&&(r.wrapS=r.wrapT=t.CLAMP_TO_EDGE)),r.image=e,r.onUpdate=()=>{e.close&&e.close(),r.onUpdate=null}})}}function dr(){return 0==document.createElement("canvas").toDataURL("image/webp").indexOf("data:image/webp")}function pr(t){return Math.log2(t)%1==0}class gr{static load(t,e){const r=ur.load(t.gl,e);return r&&r.loaded&&r.loaded.then?r.loaded.then(()=>{t.forceUpdate()}):r&&r.then&&r.then(()=>{t.forceUpdate()}),r}}const mr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\n\nuniform mat3 normalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\nvarying vec3 vNormal;\n\nvoid main() {\n    vNormal = normalize(normalMatrix * normal);\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\n\nvoid main() {\n    gl_FragColor.rgb = normalize(vNormal);\n    gl_FragColor.a = 1.0;\n}"},fr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\n\nuniform vec3 pointLightPosition; //点光源位置\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * cos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  vColor = vec4(diffuse + ambient, color.a);\n  // vColor = color;\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\n\nuniform vec4 directionalLight; //平行光 xyz - 向量位置, w - 强度\n\nvoid main() {\n  float light = dot(vNormal, normalize(directionalLight.xyz));\n  gl_FragColor.rgb = vColor.rgb + light * directionalLight.w;\n  gl_FragColor.a = vColor.a;\n}"},vr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nvarying vec3 vNormal;\nvarying vec2 vUv;\n\nvarying float fCos;\n\nuniform vec3 pointLightPosition; //点光源位置\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  \n  fCos = cos;\n\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\n\nuniform vec4 directionalLight; //平行光\n\nuniform sampler2D tMap;\nvarying vec2 vUv;\n\nvarying float fCos;\n\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nvoid main() {\n  vec4 color = texture2D(tMap, vUv);\n\n  vec3 light = normalize(directionalLight.xyz);\n  float shading = dot(vNormal, light) * directionalLight.w;\n\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * fCos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  color = vec4(diffuse + ambient, color.a);\n\n  gl_FragColor.rgb = color.rgb + shading;\n  gl_FragColor.a = color.a;\n}"},br={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nvarying vec3 vNormal;\nvarying vec3 vDir;\n\nvarying float fCos;\n\nuniform vec3 pointLightPosition; //点光源位置\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n  vDir = normalize(position);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  \n  fCos = cos;\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\nvarying vec3 vDir;\n\nuniform vec4 directionalLight; //平行光\n\nuniform samplerCube tMap;\n\nvarying float fCos;\n\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nvoid main() {\n  vec4 color = textureCube(tMap, vDir);\n\n  vec3 light = normalize(directionalLight.xyz);\n  float shading = dot(vNormal, light) * directionalLight.w;\n\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * fCos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  color = vec4(diffuse + ambient, color.a);\n\n  gl_FragColor.rgb = color.rgb + shading;\n  gl_FragColor.a = color.a;\n}"},yr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nvarying vec3 vNormal;\nvarying vec2 vUv;\n\nvarying float fCos;\nvarying vec4 vLightNDC;\n\nuniform vec3 pointLightPosition; //点光源位置\n\nuniform mat4 shadowViewMatrix;\nuniform mat4 shadowProjectionMatrix;\n\n// Matrix to shift range from -1->1 to 0->1\nconst mat4 depthScaleMatrix = mat4(\n    0.5, 0, 0, 0, \n    0, 0.5, 0, 0, \n    0, 0, 0.5, 0, \n    0.5, 0.5, 0.5, 1\n);\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  \n  fCos = cos;\n\n  vUv = uv;\n  vLightNDC = depthScaleMatrix * shadowProjectionMatrix * shadowViewMatrix * modelMatrix * vec4(position, 1.0);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\n\nuniform vec4 directionalLight; //平行光\n\nuniform sampler2D tMap;\nuniform sampler2D tShadow;\nuniform float shadow;\nvarying vec2 vUv;\n\nvarying float fCos;\n\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nvarying vec4 vLightNDC; // 阴影\n\nfloat unpackRGBA (vec4 v) {\n    return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\n\nvoid main() {\n  vec4 color = texture2D(tMap, vUv);\n\n  vec3 lightPos = vLightNDC.xyz / vLightNDC.w;\n  \n  float bias = 0.001;\n  float depth = lightPos.z - bias;\n  float occluder = unpackRGBA(texture2D(tShadow, lightPos.xy));\n\n  // Compare actual depth from light to the occluded depth rendered in the depth map\n  // If the occluded depth is smaller, we must be in shadow\n  float shadowDept = mix(shadow, 1.0, step(depth, occluder));\n\n  vec3 light = normalize(directionalLight.xyz);\n  float shading = dot(vNormal, light) * directionalLight.w;\n\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * fCos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  color = vec4(diffuse + ambient, color.a);\n\n  gl_FragColor.rgb = color.rgb * shadowDept + shading;\n  gl_FragColor.a = color.a;\n}",uniforms:{shadow:{value:.5}}},wr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvarying float fCos;\n\nuniform vec3 pointLightPosition; //点光源位置\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  \n  fCos = cos;\n\n  // vColor = vec4(diffuse + ambient, color.a);\n  vColor = color;\n\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\n\nuniform vec4 directionalLight; //平行光\n\nuniform sampler2D tMap;\nvarying vec2 vUv;\n\nvarying float fCos;\n\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nvoid main() {\n  vec4 color = vColor;\n  vec4 texColor = texture2D(tMap, vUv);\n\n  vec3 light = normalize(directionalLight.xyz);\n  float shading = dot(vNormal, light) * directionalLight.w;\n\n  float alpha = texColor.a;\n  color.rgb = mix(texColor.rgb, color.rgb, 1.0 - alpha);\n  color.a = texColor.a + (1.0 - texColor.a) * color.a;\n\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * fCos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  color = vec4(diffuse + ambient, color.a);\n\n  gl_FragColor.rgb = color.rgb + shading;\n  gl_FragColor.a = color.a;\n}"},xr={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nuniform mat4 shadowViewMatrix;\nuniform mat4 shadowProjectionMatrix;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\nvarying vec4 vLightNDC;\n\nuniform vec3 pointLightPosition; //点光源位置\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\n// Matrix to shift range from -1->1 to 0->1\nconst mat4 depthScaleMatrix = mat4(\n    0.5, 0, 0, 0, \n    0, 0.5, 0, 0, \n    0, 0, 0.5, 0, \n    0.5, 0.5, 0.5, 1\n);\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * cos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  vColor = vec4(diffuse + ambient, color.a);\n  // vColor = color;\n\n  vLightNDC = depthScaleMatrix * shadowProjectionMatrix * shadowViewMatrix * modelMatrix * vec4(position, 1.0);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\n\nuniform vec4 directionalLight;\n\nuniform sampler2D tShadow;\nuniform float shadow;\n\nvarying vec4 vLightNDC;\n\nfloat unpackRGBA (vec4 v) {\n    return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\n\nvoid main() {\n  float l = dot(vNormal, normalize(directionalLight.xyz));\n\n  vec3 lightPos = vLightNDC.xyz / vLightNDC.w;\n  \n  float bias = 0.001;\n  float depth = lightPos.z - bias;\n  float occluder = unpackRGBA(texture2D(tShadow, lightPos.xy));\n\n  // Compare actual depth from light to the occluded depth rendered in the depth map\n  // If the occluded depth is smaller, we must be in shadow\n  float shadowDept = mix(shadow, 1.0, step(depth, occluder));\n\n  gl_FragColor.rgb = vColor.rgb * shadowDept + l * directionalLight.w;\n  gl_FragColor.a = vColor.a;\n}",uniforms:{shadow:{value:.5}}},Er={vertex:"precision highp float;\nprecision highp int;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec2 uv;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat3 normalMatrix;\n\nuniform mat4 shadowViewMatrix;\nuniform mat4 shadowProjectionMatrix;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\nvarying vec2 vUv;\n\nvarying vec4 vLightNDC;\n\nvarying float fCos;\n\nuniform vec3 pointLightPosition; //点光源位置\n\n// Matrix to shift range from -1->1 to 0->1\nconst mat4 depthScaleMatrix = mat4(\n    0.5, 0, 0, 0, \n    0, 0.5, 0, 0, \n    0, 0, 0.5, 0, \n    0.5, 0.5, 0.5, 1\n);\n\nvoid main() {\n  vNormal = normalize(normalMatrix * normal);\n\n  vec3 dir = normalize(pointLightPosition - position);// 计算点光源入射光线反方向并归一化\n  float cos = max(dot(dir, vNormal), 0.0);// 计算入射角余弦值\n\n  fCos = cos;\n\n  vColor = color;\n\n  vUv = uv;\n  vLightNDC = depthScaleMatrix * shadowProjectionMatrix * shadowViewMatrix * modelMatrix * vec4(position, 1.0);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragment:"precision highp float;\nprecision highp int;\n\nvarying vec3 vNormal;\nvarying vec4 vColor;\n\nuniform vec4 directionalLight; //平行光\n\nuniform sampler2D tMap;\nuniform sampler2D tShadow;\nuniform float shadow;\n\nvarying vec2 vUv;\nvarying vec4 vLightNDC;\n\nvarying float fCos;\n\nuniform vec4 pointLightColor; // 点光源颜色\nuniform vec4 ambientColor; // 环境光\n\nfloat unpackRGBA (vec4 v) {\n  return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\n\nvoid main() {\n  vec4 color = vColor;\n  vec4 texColor = texture2D(tMap, vUv);\n\n  vec3 lightPos = vLightNDC.xyz / vLightNDC.w;\n  float bias = 0.001;\n  float depth = lightPos.z - bias;\n  float occluder = unpackRGBA(texture2D(tShadow, lightPos.xy));\n\n  // Compare actual depth from light to the occluded depth rendered in the depth map\n  // If the occluded depth is smaller, we must be in shadow\n  float shadow = mix(shadow, 1.0, step(depth, occluder));\n\n  vec3 light = normalize(directionalLight.xyz);\n  float shading = dot(vNormal, light) * directionalLight.w;\n\n  float alpha = texColor.a;\n  color.rgb = mix(texColor.rgb, color.rgb, 1.0 - alpha);\n  color.a = texColor.a + (1.0 - texColor.a) * color.a;\n\n  vec3 diffuse = pointLightColor.rgb * color.rgb * pointLightColor.a * fCos;// 计算点光源漫反射颜色\n  vec3 ambient = ambientColor.rgb * color.rgb;// 计算环境光反射颜色\n\n  color = vec4(diffuse + ambient, color.a);\n\n  gl_FragColor.rgb = color.rgb * shadow + shading;\n  gl_FragColor.a = color.a;\n}",uniforms:{shadow:{value:.5}}};r.d(e,"Layer3D",(function(){return be})),r.d(e,"Sphere",(function(){return ke})),r.d(e,"Plane",(function(){return Ke})),r.d(e,"Camera",(function(){return te})),r.d(e,"Cube",(function(){return We})),r.d(e,"Cylinder",(function(){return ir})),r.d(e,"Mesh3d",(function(){return Ie})),r.d(e,"Group3d",(function(){return Wt})),r.d(e,"RenderTarget",(function(){return ar})),r.d(e,"Shadow",(function(){return Tt})),r.d(e,"TextureLoader",(function(){return gr})),r.d(e,"shaders",(function(){return i})),r.d(e,"Vec2",(function(){return h})),r.d(e,"Vec3",(function(){return b})),r.d(e,"Vec4",(function(){return E})),r.d(e,"Mat3",(function(){return A})),r.d(e,"Mat4",(function(){return _})),r.d(e,"Quat",(function(){return j})),r.d(e,"Euler",(function(){return B})),r.d(e,"Geometry",(function(){return xe})),r.d(e,"GPGPU",(function(){return st})),ht.Scene.prototype.layer3d=function(t="default3d",e={}){const{displayRatio:r}=this.options;(e=Object.assign({dpr:r},this.options,e)).id=t;const i=this.orderedChildren;for(let e=0;e<i.length;e++)if(i[e].id===t)return i[e];const n=new be(e);return this.appendChild(n),n}}])}));